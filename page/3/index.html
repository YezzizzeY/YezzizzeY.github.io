<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Yezzi Tech</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Nice paper collection, computer tech records, and personal thoughts">
<meta property="og:type" content="website">
<meta property="og:title" content="Yezzi Tech">
<meta property="og:url" content="https://yezzi.tech/page/3/index.html">
<meta property="og:site_name" content="Yezzi Tech">
<meta property="og:description" content="Nice paper collection, computer tech records, and personal thoughts">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Mingzhe Liu">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Yezzi Tech" type="application/atom+xml">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  
<link rel="stylesheet" href="/css/styles.css">

  

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class=""
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
          <li><a href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a></li>
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">Yezzi Tech</h1>
  
</div>

    <div class="row">
        <div class="col-sm-8 blog-main">
          
  
    <article id="post-geth控制台代码分析" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/02/geth%E6%8E%A7%E5%88%B6%E5%8F%B0%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">(no title)</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2021/07/02/geth%E6%8E%A7%E5%88%B6%E5%8F%B0%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" class="article-date"><time datetime="2021-07-02T11:06:38.680Z" itemprop="datePublished">2021-07-02</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="1-goja"><a href="#1-goja" class="headerlink" title="1.goja"></a>1.goja</h4><p>goja 是一个 Go 实现的 ECMAScript 5.1(+)。</p>
<p>它不是 V8 或 SpiderMonkey 或任何其他通用 JavaScript 引擎的替代品，因为它更慢。它可以作为一种嵌入式脚本语言使用，或者可以作为避免非 Go 相关性的一种方式。</p>
<p>灵感来源于 <a target="_blank" rel="noopener" href="https://github.com/robertkrimen/otto">otto</a> 。完全支持 ECMAScript 5.1，通过几乎所有用 es5id 标记的 tc39 测试，平均比 otto 快6-7倍，同时使用相当少的内存。</p>
<p>简单的理解是，在go里面写javascript，这样就可以以脚本的方式实现控制台，并和geth实时交互。</p>
<h4 id="2-RPC"><a href="#2-RPC" class="headerlink" title="2.RPC"></a>2.RPC</h4><p>默认socket通信。本地机器的RPC框架反序列化出执行结果，函数return这个结果。</p>
<p> <img src="https://upload-images.jianshu.io/upload_images/729358-839e7a32b598953e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/500/format/webp" alt="img"> </p>
<p><strong>Call ID映射。</strong>我们怎么告诉远程机器我们要调用Multiply，而不是Add或者FooBar呢？在本地调用中，函数体是直接通过函数指针来指定的，我们调用Multiply，编译器就自动帮我们调用它相应的函数指针。但是在远程调用中，函数指针是不行的，因为两个进程的地址空间是完全不一样的。所以，在RPC中，所有的函数都必须有自己的一个ID。这个ID在所有进程中都是唯一确定的。客户端在做远程过程调用时，必须附上这个ID。然后我们还需要在客户端和服务端分别维护一个 {函数 &lt;–&gt; Call ID} 的对应表。两者的表不一定需要完全相同，但相同的函数对应的Call ID必须相同。当客户端需要进行远程调用时，它就查一下这个表，找出相应的Call ID，然后把它传给服务端，服务端也通过查表，来确定客户端需要调用的函数，然后执行相应函数的代码。</p>
<p><strong>序列化和反序列化。</strong>客户端怎么把参数值传给远程的函数呢？在本地调用中，我们只需要把参数压到栈里，然后让函数自己去栈里读就行。但是在远程过程调用时，客户端跟服务端是不同的进程，不能通过内存来传递参数。甚至有时候客户端和服务端使用的都不是同一种语言（比如服务端用C++，客户端用Java或者Python）。这时候就需要客户端把参数先转成一个字节流，传给服务端后，再把字节流转成自己能读取的格式。这个过程叫序列化和反序列化。同理，从服务端返回的值也需要序列化反序列化的过程。</p>
<p><strong>网络传输。</strong>远程调用往往用在网络上，客户端和服务端是通过网络连接的。所有的数据都需要通过网络传输，因此就需要有一个网络传输层。网络传输层需要把Call ID和序列化后的参数字节流传给服务端，然后再把序列化后的调用结果传回客户端。只要能完成这两者的，都可以作为传输层使用。因此，它所使用的协议其实是不限的，能完成传输就行。尽管大部分RPC框架都使用TCP协议，但其实UDP也可以，而gRPC干脆就用了HTTP2。Java的Netty也属于这层的东西。</p>
<p> <img src="https://upload-images.jianshu.io/upload_images/729358-de38e5423ffbc3e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/589/format/webp" alt="img"> </p>
<p><strong>3.控制台原理</strong></p>
<p>geth/main.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Initialize the CLI app and start Geth</span></span><br><span class="line">	app.Action = geth</span><br><span class="line">	app.HideVersion = <span class="literal">true</span> <span class="comment">// we have a command to print the version</span></span><br><span class="line">	app.Copyright = <span class="string">&quot;Copyright 2013-2020 The go-ethereum Authors&quot;</span></span><br><span class="line">	app.Commands = []cli.Command&#123;</span><br><span class="line">		<span class="comment">// See chaincmd.go:</span></span><br><span class="line">		...</span><br><span class="line">		consoleCommand,</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>geth/consolecmd.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">consoleCommand = cli.Command&#123;</span><br><span class="line">		Action:   utils.MigrateFlags(localConsole),</span><br><span class="line">		Name:     <span class="string">&quot;console&quot;</span>,</span><br><span class="line">		Usage:    <span class="string">&quot;Start an interactive JavaScript environment&quot;</span>,</span><br><span class="line">		Flags:    <span class="built_in">append</span>(<span class="built_in">append</span>(<span class="built_in">append</span>(nodeFlags, rpcFlags...), consoleFlags...), whisperFlags...),</span><br><span class="line">		Category: <span class="string">&quot;CONSOLE COMMANDS&quot;</span>,</span><br><span class="line">		Description: <span class="string">`</span></span><br><span class="line"><span class="string">The Geth console is an interactive shell for the JavaScript runtime environment</span></span><br><span class="line"><span class="string">which exposes a node admin interface as well as the Ðapp JavaScript API.</span></span><br><span class="line"><span class="string">See https://github.com/ethereum/go-ethereum/wiki/JavaScript-Console.`</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// localConsole starts a new geth node, attaching a JavaScript console to it at the</span></span><br><span class="line"><span class="comment">// same time.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">localConsole</span><span class="params">(ctx *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// Create and start the node based on the CLI flags</span></span><br><span class="line">    <span class="comment">// 和geth命令有些相似，只不过没有node.wait（），就是启动一个节点</span></span><br><span class="line">	prepare(ctx)</span><br><span class="line">	node := makeFullNode(ctx)</span><br><span class="line">	startNode(ctx, node)</span><br><span class="line">	<span class="keyword">defer</span> node.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Attach to the newly started node and start the JavaScript console</span></span><br><span class="line">	client, err := node.Attach()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;Failed to attach to the inproc geth: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	config := console.Config&#123;</span><br><span class="line">		DataDir: utils.MakeDataDir(ctx),</span><br><span class="line">		DocRoot: ctx.GlobalString(utils.JSpathFlag.Name),</span><br><span class="line">		Client:  client,</span><br><span class="line">		Preload: utils.MakeConsolePreloads(ctx),</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//新建控制台</span></span><br><span class="line">	console, err := console.New(config)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;Failed to start the JavaScript console: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> console.Stop(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If only a short execution was requested, evaluate and return</span></span><br><span class="line">	<span class="keyword">if</span> script := ctx.GlobalString(utils.ExecFlag.Name); script != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		console.Evaluate(script)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Otherwise print the welcome screen and enter interactive mode</span></span><br><span class="line">    <span class="comment">// 说欢迎，开启交互模式</span></span><br><span class="line">	console.Welcome()</span><br><span class="line">	console.Interactive()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>console/bridge.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bridge is a collection of JavaScript utility methods to bride the .js runtime</span></span><br><span class="line"><span class="comment">// environment and the Go RPC connection backing the remote method calls.</span></span><br><span class="line"><span class="keyword">type</span> bridge <span class="keyword">struct</span> &#123;</span><br><span class="line">	client   *rpc.Client  <span class="comment">// RPC client to execute Ethereum requests through</span></span><br><span class="line">	prompter UserPrompter <span class="comment">// Input prompter to allow interactive user feedback输入提示，允许交互式用户反馈</span></span><br><span class="line">	printer  io.Writer    <span class="comment">// Output writer to serialize any display strings序列化 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// newBridge creates a new JavaScript wrapper around an RPC client.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newBridge</span><span class="params">(client *rpc.Client, prompter UserPrompter, printer io.Writer)</span> *<span class="title">bridge</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;bridge&#123;</span><br><span class="line">		client:   client,</span><br><span class="line">		prompter: prompter,</span><br><span class="line">		printer:  printer,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>console/console.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init retrieves the available APIs from the remote RPC provider and initializes</span></span><br><span class="line"><span class="comment">// the console&#x27;s JavaScript namespaces based on the exposed modules.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Console)</span> <span class="title">init</span><span class="params">(preload []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	c.initConsoleObject()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize the JavaScript &lt;-&gt; Go RPC bridge.</span></span><br><span class="line">	bridge := newBridge(c.client, c.prompter, c.printer)</span><br><span class="line">	<span class="keyword">if</span> err := c.initWeb3(bridge); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := c.initExtensions(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add bridge overrides for web3.js functionality.</span></span><br><span class="line">	c.jsre.Do(<span class="function"><span class="keyword">func</span><span class="params">(vm *goja.Runtime)</span></span> &#123;</span><br><span class="line">		c.initAdmin(vm, bridge)</span><br><span class="line">		c.initPersonal(vm, bridge)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Preload JavaScript files.</span></span><br><span class="line">	<span class="keyword">for</span> _, path := <span class="keyword">range</span> preload &#123;</span><br><span class="line">		<span class="keyword">if</span> err := c.jsre.Exec(path); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			failure := err.Error()</span><br><span class="line">			<span class="keyword">if</span> gojaErr, ok := err.(*goja.Exception); ok &#123;</span><br><span class="line">				failure = gojaErr.String()</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s: %v&quot;</span>, path, failure)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Configure the input prompter for history and tab completion.</span></span><br><span class="line">    <span class="comment">// 为历史记录和制表符完成配置输入提示。</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> c.prompter != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> content, err := ioutil.ReadFile(c.histPath); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.prompter.SetHistory(<span class="literal">nil</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			c.history = strings.Split(<span class="keyword">string</span>(content), <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">			c.prompter.SetHistory(c.history)</span><br><span class="line">		&#125;</span><br><span class="line">		c.prompter.SetWordCompleter(c.AutoCompleteInput)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(config Config)</span> <span class="params">(*Console, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Handle unset config values gracefully</span></span><br><span class="line">	<span class="keyword">if</span> config.Prompter == <span class="literal">nil</span> &#123;</span><br><span class="line">		config.Prompter = Stdin</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> config.Prompt == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		config.Prompt = DefaultPrompt</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> config.Printer == <span class="literal">nil</span> &#123;</span><br><span class="line">		config.Printer = colorable.NewColorableStdout()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize the console and return</span></span><br><span class="line">	console := &amp;Console&#123;</span><br><span class="line">		client:   config.Client,</span><br><span class="line">		jsre:     jsre.New(config.DocRoot, config.Printer),</span><br><span class="line">		prompt:   config.Prompt,</span><br><span class="line">		prompter: config.Prompter,</span><br><span class="line">		printer:  config.Printer,</span><br><span class="line">		histPath: filepath.Join(config.DataDir, HistoryFile),</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := os.MkdirAll(config.DataDir, <span class="number">0700</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := console.init(config.Preload); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> console, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Welcome show summary of current Geth instance and some metadata about the</span></span><br><span class="line"><span class="comment">// console&#x27;s available modules.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Console)</span> <span class="title">Welcome</span><span class="params">()</span></span> &#123;</span><br><span class="line">	message := <span class="string">&quot;Welcome to the Geth JavaScript console!\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Print some generic Geth metadata</span></span><br><span class="line">	<span class="keyword">if</span> res, err := c.jsre.Run(<span class="string">`</span></span><br><span class="line"><span class="string">		var message = &quot;instance: &quot; + web3.version.node + &quot;\n&quot;;</span></span><br><span class="line"><span class="string">		try &#123;</span></span><br><span class="line"><span class="string">			message += &quot;coinbase: &quot; + eth.coinbase + &quot;\n&quot;;</span></span><br><span class="line"><span class="string">		&#125; catch (err) &#123;&#125;</span></span><br><span class="line"><span class="string">		message += &quot;at block: &quot; + eth.blockNumber + &quot; (&quot; + new Date(1000 * eth.getBlock(eth.blockNumber).timestamp) + &quot;)\n&quot;;</span></span><br><span class="line"><span class="string">		try &#123;</span></span><br><span class="line"><span class="string">			message += &quot; datadir: &quot; + admin.datadir + &quot;\n&quot;;</span></span><br><span class="line"><span class="string">		&#125; catch (err) &#123;&#125;</span></span><br><span class="line"><span class="string">		message</span></span><br><span class="line"><span class="string">	`</span>); </span><br><span class="line">    ...</span><br><span class="line">	fmt.Fprintln(c.printer, message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Interactive starts an interactive user session, where input is propted from</span></span><br><span class="line"><span class="comment">// the configured user prompter.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Console)</span> <span class="title">Interactive</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-一个交互举例子"><a href="#4-一个交互举例子" class="headerlink" title="4.一个交互举例子"></a>4.一个交互举例子</h4><p>console/console.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Console)</span> <span class="title">initWeb3</span><span class="params">(bridge *bridge)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	bnJS := <span class="keyword">string</span>(deps.MustAsset(<span class="string">&quot;bignumber.js&quot;</span>))</span><br><span class="line">	web3JS := <span class="keyword">string</span>(deps.MustAsset(<span class="string">&quot;web3.js&quot;</span>))</span><br><span class="line">	<span class="keyword">if</span> err := c.jsre.Compile(<span class="string">&quot;bignumber.js&quot;</span>, bnJS); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;bignumber.js: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := c.jsre.Compile(<span class="string">&quot;web3.js&quot;</span>, web3JS); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;web3.js: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> _, err := c.jsre.Run(<span class="string">&quot;var Web3 = require(&#x27;web3&#x27;);&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;web3 require: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	c.jsre.Do(<span class="function"><span class="keyword">func</span><span class="params">(vm *goja.Runtime)</span></span> &#123;</span><br><span class="line">		transport := vm.NewObject()</span><br><span class="line">		transport.Set(<span class="string">&quot;send&quot;</span>, jsre.MakeCallback(vm, bridge.Send))</span><br><span class="line">		transport.Set(<span class="string">&quot;sendAsync&quot;</span>, jsre.MakeCallback(vm, bridge.Send))</span><br><span class="line">		vm.Set(<span class="string">&quot;_consoleWeb3Transport&quot;</span>, transport)</span><br><span class="line">		_, err = vm.RunString(<span class="string">&quot;var web3 = new Web3(_consoleWeb3Transport)&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拿其中的send方法举例</p>
<p>console/bridge.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Send implements the web3 provider &quot;send&quot; method.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *bridge)</span> <span class="title">Send</span><span class="params">(call jsre.Call)</span> <span class="params">(goja.Value, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Remarshal the request into a Go value.</span></span><br><span class="line">	reqVal, err := call.Argument(<span class="number">0</span>).ToObject(call.VM).MarshalJSON()</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		rawReq = <span class="keyword">string</span>(reqVal)</span><br><span class="line">		dec    = json.NewDecoder(strings.NewReader(rawReq))</span><br><span class="line">		reqs   []jsonrpcCall</span><br><span class="line">		batch  <span class="keyword">bool</span></span><br><span class="line">	)</span><br><span class="line">	dec.UseNumber() <span class="comment">// avoid float64s</span></span><br><span class="line">	<span class="keyword">if</span> rawReq[<span class="number">0</span>] == <span class="string">&#x27;[&#x27;</span> &#123;</span><br><span class="line">		batch = <span class="literal">true</span></span><br><span class="line">		dec.Decode(&amp;reqs)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		batch = <span class="literal">false</span></span><br><span class="line">		reqs = <span class="built_in">make</span>([]jsonrpcCall, <span class="number">1</span>)</span><br><span class="line">		dec.Decode(&amp;reqs[<span class="number">0</span>])</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Execute the requests.</span></span><br><span class="line">	<span class="keyword">var</span> resps []*goja.Object</span><br><span class="line">	<span class="keyword">for</span> _, req := <span class="keyword">range</span> reqs &#123;</span><br><span class="line">		resp := call.VM.NewObject()</span><br><span class="line">		resp.Set(<span class="string">&quot;jsonrpc&quot;</span>, <span class="string">&quot;2.0&quot;</span>)</span><br><span class="line">		resp.Set(<span class="string">&quot;id&quot;</span>, req.ID)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> result json.RawMessage</span><br><span class="line">        <span class="comment">//比较重要的一步，rpc调用</span></span><br><span class="line">		err = b.client.Call(&amp;result, req.Method, req.Params...)</span><br><span class="line">		<span class="keyword">switch</span> err := err.(<span class="keyword">type</span>) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="literal">nil</span>:</span><br><span class="line">			<span class="keyword">if</span> result == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="comment">// Special case null because it is decoded as an empty</span></span><br><span class="line">				<span class="comment">// raw message for some reason.</span></span><br><span class="line">				resp.Set(<span class="string">&quot;result&quot;</span>, goja.Null())</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				JSON := call.VM.Get(<span class="string">&quot;JSON&quot;</span>).ToObject(call.VM)</span><br><span class="line">				parse, callable := goja.AssertFunction(JSON.Get(<span class="string">&quot;parse&quot;</span>))</span><br><span class="line">				<span class="keyword">if</span> !callable &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;JSON.parse is not a function&quot;</span>)</span><br><span class="line">				&#125;</span><br><span class="line">				resultVal, err := parse(goja.Null(), call.VM.ToValue(<span class="keyword">string</span>(result)))</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					setError(resp, <span class="number">-32603</span>, err.Error())</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					resp.Set(<span class="string">&quot;result&quot;</span>, resultVal)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> rpc.Error:</span><br><span class="line">			setError(resp, err.ErrorCode(), err.Error())</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			setError(resp, <span class="number">-32603</span>, err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">		resps = <span class="built_in">append</span>(resps, resp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Return the responses either to the callback (if supplied)</span></span><br><span class="line">	<span class="comment">// or directly as the return value.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将响应返回给回调（如果提供）</span></span><br><span class="line">    <span class="comment">//或直接作为返回值。</span></span><br><span class="line">	<span class="keyword">var</span> result goja.Value</span><br><span class="line">	<span class="keyword">if</span> batch &#123;</span><br><span class="line">		result = call.VM.ToValue(resps)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		result = resps[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> fn, isFunc := goja.AssertFunction(call.Argument(<span class="number">1</span>)); isFunc &#123;</span><br><span class="line">		fn(goja.Null(), goja.Null(), result)</span><br><span class="line">		<span class="keyword">return</span> goja.Undefined(), <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="https://yezzi.tech/2021/07/02/geth%E6%8E%A7%E5%88%B6%E5%8F%B0%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" data-id="ckqm8q8sz000ir8u76aivbehl" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-geth启动代码分析（3）" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/02/geth%E5%90%AF%E5%8A%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%883%EF%BC%89/">(no title)</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2021/07/02/geth%E5%90%AF%E5%8A%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%883%EF%BC%89/" class="article-date"><time datetime="2021-07-02T11:06:38.679Z" itemprop="datePublished">2021-07-02</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h6 id="1-defer函数"><a href="#1-defer函数" class="headerlink" title="1.defer函数"></a>1.defer函数</h6><p>延迟（defer）语句：可以在函数中添加多个defer语句。当函数执行到最后时，这些defer语句会按照逆序执行，最后该函数返回。特别是当你在进行一些打开资源的操作时，遇到错误需要提前返回，在返回前你需要关闭相应的资源，不然很容易造成资源泄露等问题。</p>
<p>例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadWrite</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    file.Open(<span class="string">&quot;file&quot;</span>)</span><br><span class="line"><span class="comment">// 做一些工作</span></span><br><span class="line">    <span class="keyword">if</span> failureX &#123;</span><br><span class="line">        file.Close()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> failureY &#123;</span><br><span class="line">        file.Close()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file.Close()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>defer版本：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadWrite</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    file.Open(<span class="string">&quot;file&quot;</span>)</span><br><span class="line">    <span class="keyword">defer</span> file.Close()</span><br><span class="line">    <span class="keyword">if</span> failureX &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> failureY &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="2-goalng内置new函数"><a href="#2-goalng内置new函数" class="headerlink" title="2.goalng内置new函数"></a>2.goalng内置new函数</h6><p>这是一个用来分配内存的内置函数，它的第一个参数是一个类型，不是一个值，它的返回值是一个指向新分配的 t 类型的零值的指针。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">new</span><span class="params">(t Type)</span> *<span class="title">Type</span></span> </span><br></pre></td></tr></table></figure>

<p>和struct{}初始化的方式相比，struct{}初始化返回的是一个struct类型的值，而不是指针。</p>
<p>例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span>&#123;</span><br><span class="line">	id <span class="keyword">int</span></span><br><span class="line">	name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> s_1 *Student = <span class="built_in">new</span>(Student)</span><br><span class="line">	s_1.id = <span class="number">100</span></span><br><span class="line">	s_1.name = <span class="string">&quot;cat&quot;</span></span><br><span class="line">	<span class="keyword">var</span> s_2 Student = Student&#123;id:<span class="number">1</span>,name:<span class="string">&quot;tom&quot;</span>&#125;</span><br><span class="line">	fmt.Println(s_1,s_2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;&#123;<span class="number">100</span> cat&#125; &#123;<span class="number">1</span> tom&#125;</span><br></pre></td></tr></table></figure>



<h6 id="3-initGenesis方法"><a href="#3-initGenesis方法" class="headerlink" title="3.initGenesis方法"></a>3.initGenesis方法</h6><p>对应着cmd指令：geth –datadir  /data  genesis.json init</p>
<p>对于initCommand的描述：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">	initCommand = cli.Command&#123;</span><br><span class="line">		Action:    utils.MigrateFlags(initGenesis),</span><br><span class="line">		Name:      <span class="string">&quot;init&quot;</span>,</span><br><span class="line">		Usage:     <span class="string">&quot;Bootstrap and initialize a new genesis block&quot;</span>,</span><br><span class="line">		ArgsUsage: <span class="string">&quot;&lt;genesisPath&gt;&quot;</span>,</span><br><span class="line">		Flags: []cli.Flag&#123;</span><br><span class="line">			utils.DataDirFlag,</span><br><span class="line">		&#125;,</span><br><span class="line">		Category: <span class="string">&quot;BLOCKCHAIN COMMANDS&quot;</span>,</span><br><span class="line">		Description: <span class="string">`</span></span><br><span class="line"><span class="string">The init command initializes a new genesis block and definition for the network.</span></span><br><span class="line"><span class="string">This is a destructive action and changes the network in which you will be</span></span><br><span class="line"><span class="string">participating.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">It expects the genesis file as argument.`</span></span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<p>调用的函数：initGenesis</p>
<p>解析了一个flag的值：DataDirFlag</p>
<p>指令：init</p>
<p>flag之外的参数说明：genesis路径</p>
<p>代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// initGenesis will initialise the given JSON format genesis file and writes it as</span></span><br><span class="line"><span class="comment">// the zero&#x27;d block (i.e. genesis) or will fail hard if it can&#x27;t succeed.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initGenesis</span><span class="params">(ctx *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// Make sure we have a valid genesis JSON</span></span><br><span class="line">	genesisPath := ctx.Args().First()</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(genesisPath) == <span class="number">0</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;Must supply path to genesis JSON file&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	file, err := os.Open(genesisPath)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;Failed to read genesis file: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">	genesis := <span class="built_in">new</span>(core.Genesis)</span><br><span class="line">	<span class="keyword">if</span> err := json.NewDecoder(file).Decode(genesis); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;invalid genesis file: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Open an initialise both full and light databases</span></span><br><span class="line">	stack := makeFullNode(ctx)</span><br><span class="line">	<span class="keyword">defer</span> stack.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, name := <span class="keyword">range</span> []<span class="keyword">string</span>&#123;<span class="string">&quot;chaindata&quot;</span>, <span class="string">&quot;lightchaindata&quot;</span>&#125; &#123;</span><br><span class="line">		chaindb, err := stack.OpenDatabase(name, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			utils.Fatalf(<span class="string">&quot;Failed to open database: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		_, hash, err := core.SetupGenesisBlock(chaindb, genesis)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			utils.Fatalf(<span class="string">&quot;Failed to write genesis block: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		chaindb.Close()</span><br><span class="line">		log.Info(<span class="string">&quot;Successfully wrote genesis state&quot;</span>, <span class="string">&quot;database&quot;</span>, name, <span class="string">&quot;hash&quot;</span>, hash)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>首先读取指令</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">genesisPath := ctx.Args().First()</span><br></pre></td></tr></table></figure>

<p>它指明了genesisPath变量是cmd指令的flag之外的第一个变量：</p>
<p>context.go文件</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Args []<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Args returns the command line arguments associated with the context.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">Args</span><span class="params">()</span> <span class="title">Args</span></span> &#123;</span><br><span class="line">	args := Args(c.flagSet.Args())</span><br><span class="line">	<span class="keyword">return</span> args</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Args returns the non-flag arguments.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">Args</span><span class="params">()</span> []<span class="title">string</span></span> &#123; <span class="keyword">return</span> f.args &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a Args)</span> <span class="title">First</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> a.Get(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get returns the nth argument, or else a blank string</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a Args)</span> <span class="title">Get</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(a) &gt; n &#123;</span><br><span class="line">		<span class="keyword">return</span> a[n]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flag.go文件</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// A FlagSet represents a set of defined flags. The zero value of a FlagSet</span></span><br><span class="line"><span class="comment">// has no name and has ContinueOnError error handling.</span></span><br><span class="line"><span class="keyword">type</span> FlagSet <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Usage is the function called when an error occurs while parsing flags.</span></span><br><span class="line">	<span class="comment">// The field is a function (not a method) that may be changed to point to</span></span><br><span class="line">	<span class="comment">// a custom error handler. What happens after Usage is called depends</span></span><br><span class="line">	<span class="comment">// on the ErrorHandling setting; for the command line, this defaults</span></span><br><span class="line">	<span class="comment">// to ExitOnError, which exits the program after calling Usage.</span></span><br><span class="line">	Usage <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">	name          <span class="keyword">string</span></span><br><span class="line">	parsed        <span class="keyword">bool</span></span><br><span class="line">	actual        <span class="keyword">map</span>[<span class="keyword">string</span>]*Flag</span><br><span class="line">	formal        <span class="keyword">map</span>[<span class="keyword">string</span>]*Flag</span><br><span class="line">	args          []<span class="keyword">string</span> <span class="comment">// arguments after flags</span></span><br><span class="line">	errorHandling ErrorHandling</span><br><span class="line">	output        io.Writer <span class="comment">// nil means stderr; use out() accessor</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可能有点绕，我说下自己的解释说明：</p>
<p>首先ctx.Args函数从FlagSet结构体中获取args，再把它转换为本包中的Args类型，但其实都是字符串切片。再通过First函数，First函数再调用get函数获得命令行的第一个参数。</p>
<p><strong>第二步打开文件</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">file, err := os.Open(genesisPath)</span><br><span class="line"><span class="keyword">defer</span> file.Close()</span><br></pre></td></tr></table></figure>

<p>以只读的方式打开文件，返回指向文件的指针file</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(*File, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> OpenFile(name, O_RDONLY, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第三步创建genesis对象</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">genesis := <span class="built_in">new</span>(core.Genesis)</span><br><span class="line">	<span class="keyword">if</span> err := json.NewDecoder(file).Decode(genesis); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;invalid genesis file: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>core/genesis.go中有定义Genesis结构体：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Genesis <span class="keyword">struct</span> &#123;</span><br><span class="line">	Config     *params.ChainConfig <span class="string">`json:&quot;config&quot;`</span></span><br><span class="line">	Nonce      <span class="keyword">uint64</span>              <span class="string">`json:&quot;nonce&quot;`</span></span><br><span class="line">	Timestamp  <span class="keyword">uint64</span>              <span class="string">`json:&quot;timestamp&quot;`</span></span><br><span class="line">	ExtraData  []<span class="keyword">byte</span>              <span class="string">`json:&quot;extraData&quot;`</span></span><br><span class="line">	GasLimit   <span class="keyword">uint64</span>              <span class="string">`json:&quot;gasLimit&quot;   gencodec:&quot;required&quot;`</span></span><br><span class="line">	Difficulty *big.Int            <span class="string">`json:&quot;difficulty&quot; gencodec:&quot;required&quot;`</span></span><br><span class="line">	Mixhash    common.Hash         <span class="string">`json:&quot;mixHash&quot;`</span></span><br><span class="line">	Coinbase   common.Address      <span class="string">`json:&quot;coinbase&quot;`</span></span><br><span class="line">	Alloc      GenesisAlloc        <span class="string">`json:&quot;alloc&quot;      gencodec:&quot;required&quot;`</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// These fields are used for consensus tests. Please don&#x27;t use them</span></span><br><span class="line">	<span class="comment">// in actual genesis blocks.</span></span><br><span class="line">	Number     <span class="keyword">uint64</span>      <span class="string">`json:&quot;number&quot;`</span></span><br><span class="line">	GasUsed    <span class="keyword">uint64</span>      <span class="string">`json:&quot;gasUsed&quot;`</span></span><br><span class="line">	ParentHash common.Hash <span class="string">`json:&quot;parentHash&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后检查genesis的文件格式是否正确：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Decoder reads and decodes JSON values from an input stream.</span></span><br><span class="line"><span class="keyword">type</span> Decoder <span class="keyword">struct</span> &#123;</span><br><span class="line">	r       io.Reader</span><br><span class="line">	buf     []<span class="keyword">byte</span></span><br><span class="line">	d       decodeState</span><br><span class="line">	scanp   <span class="keyword">int</span>   <span class="comment">// start of unread data in buf</span></span><br><span class="line">	scanned <span class="keyword">int64</span> <span class="comment">// amount of data already scanned</span></span><br><span class="line">	scan    scanner</span><br><span class="line">	err     error</span><br><span class="line"></span><br><span class="line">	tokenState <span class="keyword">int</span></span><br><span class="line">	tokenStack []<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//NewDecoder returns a new decoder that reads from r.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDecoder</span><span class="params">(r io.Reader)</span> *<span class="title">Decoder</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Decoder&#123;r: r&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Decode reads the next JSON-encoded value from its</span></span><br><span class="line"><span class="comment">// input and stores it in the value pointed to by v.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dec *Decoder)</span> <span class="title">Decode</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span></span> </span><br></pre></td></tr></table></figure>

<p>关于如何检查文件的先不深究，具体源码在上面，是go的源码包中的流处理的函数</p>
<p><strong>第四步创建节点</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stack := makeFullNode(ctx)</span><br><span class="line"><span class="keyword">defer</span> stack.Close()</span><br></pre></td></tr></table></figure>

<p>具体节点如何配置以后详细看</p>
<p><strong>第五步创建leveldb数据库</strong></p>
<p>chaincmd.go:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, name := <span class="keyword">range</span> []<span class="keyword">string</span>&#123;<span class="string">&quot;chaindata&quot;</span>, <span class="string">&quot;lightchaindata&quot;</span>&#125; &#123;</span><br><span class="line">	chaindb, err := stack.OpenDatabase(name, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;Failed to open database: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	_, hash, err := core.SetupGenesisBlock(chaindb, genesis)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;Failed to write genesis block: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	chaindb.Close()</span><br><span class="line">	log.Info(<span class="string">&quot;Successfully wrote genesis state&quot;</span>, <span class="string">&quot;database&quot;</span>, name, <span class="string">&quot;hash&quot;</span>, hash)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>node.go：似乎还可以不指定目录名称创建一个临时数据库，暂不深究</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OpenDatabase opens an existing database with the given name (or creates one if no</span></span><br><span class="line"><span class="comment">// previous can be found) from within the node&#x27;s instance directory. If the node is</span></span><br><span class="line"><span class="comment">// ephemeral, a memory database is returned.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *Node)</span> <span class="title">OpenDatabase</span><span class="params">(name <span class="keyword">string</span>, cache, handles <span class="keyword">int</span>, namespace <span class="keyword">string</span>)</span> <span class="params">(ethdb.Database, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> n.config.DataDir == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> rawdb.NewMemoryDatabase(), <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rawdb.NewLevelDBDatabase(n.config.ResolvePath(name), cache, handles, namespace)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>database.go:和leveldb的api进行交互，创建数据库</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewLevelDBDatabase creates a persistent key-value database without a freezer</span></span><br><span class="line"><span class="comment">// moving immutable chain segments into cold storage.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLevelDBDatabase</span><span class="params">(file <span class="keyword">string</span>, cache <span class="keyword">int</span>, handles <span class="keyword">int</span>, namespace <span class="keyword">string</span>)</span> <span class="params">(ethdb.Database, error)</span></span> &#123;</span><br><span class="line">	db, err := leveldb.New(file, cache, handles, namespace)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> NewDatabase(db), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewDatabase creates a high level database on top of a given key-value data</span></span><br><span class="line"><span class="comment">// store without a freezer moving immutable chain segments into cold storage.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDatabase</span><span class="params">(db ethdb.KeyValueStore)</span> <span class="title">ethdb</span>.<span class="title">Database</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;nofreezedb&#123;</span><br><span class="line">		KeyValueStore: db,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后就是分别创建lightchaindata和chaindata，并取哈希，存入日志中。</p>
<h6 id="4-SetupGenesisBlock的方法"><a href="#4-SetupGenesisBlock的方法" class="headerlink" title="4.SetupGenesisBlock的方法"></a>4.SetupGenesisBlock的方法</h6><p>这个比较有意思了，看代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// SetupGenesisBlock writes or updates the genesis block in db.</span></span><br><span class="line"><span class="comment">// The block that will be used is:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                          genesis == nil       genesis != nil</span></span><br><span class="line"><span class="comment">//                       +------------------------------------------</span></span><br><span class="line"><span class="comment">//     db has no genesis |  main-net default  |  genesis</span></span><br><span class="line"><span class="comment">//     db has genesis    |  from DB           |  genesis (if compatible)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The stored chain configuration will be updated if it is compatible (i.e. does not</span></span><br><span class="line"><span class="comment">// specify a fork block below the local head block). In case of a conflict, the</span></span><br><span class="line"><span class="comment">// error is a *params.ConfigCompatError and the new, unwritten config is returned.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The returned chain configuration is never nil.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetupGenesisBlock</span><span class="params">(db ethdb.Database, genesis *Genesis)</span> <span class="params">(*params.ChainConfig, common.Hash, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> SetupGenesisBlockWithOverride(db, genesis, <span class="literal">nil</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetupGenesisBlockWithOverride</span><span class="params">(db ethdb.Database, genesis *Genesis, overrideIstanbul, overrideMuirGlacier *big.Int)</span> <span class="params">(*params.ChainConfig, common.Hash, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> genesis != <span class="literal">nil</span> &amp;&amp; genesis.Config == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> params.AllEthashProtocolChanges, common.Hash&#123;&#125;, errGenesisNoConfig</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Just commit the new block if there is no stored genesis block.</span></span><br><span class="line">	stored := rawdb.ReadCanonicalHash(db, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> (stored == common.Hash&#123;&#125;) &#123;</span><br><span class="line">		<span class="keyword">if</span> genesis == <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Info(<span class="string">&quot;Writing default main-net genesis block&quot;</span>)</span><br><span class="line">			genesis = DefaultGenesisBlock()</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			log.Info(<span class="string">&quot;Writing custom genesis block&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		block, err := genesis.Commit(db)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> genesis.Config, common.Hash&#123;&#125;, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> genesis.Config, block.Hash(), <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We have the genesis block in database(perhaps in ancient database)</span></span><br><span class="line">	<span class="comment">// but the corresponding state is missing.</span></span><br><span class="line">	header := rawdb.ReadHeader(db, stored, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> _, err := state.New(header.Root, state.NewDatabaseWithCache(db, <span class="number">0</span>)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> genesis == <span class="literal">nil</span> &#123;</span><br><span class="line">			genesis = DefaultGenesisBlock()</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Ensure the stored genesis matches with the given one.</span></span><br><span class="line">		hash := genesis.ToBlock(<span class="literal">nil</span>).Hash()</span><br><span class="line">		<span class="keyword">if</span> hash != stored &#123;</span><br><span class="line">			<span class="keyword">return</span> genesis.Config, hash, &amp;GenesisMismatchError&#123;stored, hash&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		block, err := genesis.Commit(db)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> genesis.Config, hash, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> genesis.Config, block.Hash(), <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check whether the genesis block is already written.</span></span><br><span class="line">	<span class="keyword">if</span> genesis != <span class="literal">nil</span> &#123;</span><br><span class="line">		hash := genesis.ToBlock(<span class="literal">nil</span>).Hash()</span><br><span class="line">		<span class="keyword">if</span> hash != stored &#123;</span><br><span class="line">			<span class="keyword">return</span> genesis.Config, hash, &amp;GenesisMismatchError&#123;stored, hash&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get the existing chain configuration.</span></span><br><span class="line">	newcfg := genesis.configOrDefault(stored)</span><br><span class="line">	<span class="keyword">if</span> overrideIstanbul != <span class="literal">nil</span> &#123;</span><br><span class="line">		newcfg.IstanbulBlock = overrideIstanbul</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> overrideMuirGlacier != <span class="literal">nil</span> &#123;</span><br><span class="line">		newcfg.MuirGlacierBlock = overrideMuirGlacier</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := newcfg.CheckConfigForkOrder(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> newcfg, common.Hash&#123;&#125;, err</span><br><span class="line">	&#125;</span><br><span class="line">	storedcfg := rawdb.ReadChainConfig(db, stored)</span><br><span class="line">	<span class="keyword">if</span> storedcfg == <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Warn(<span class="string">&quot;Found genesis block without chain config&quot;</span>)</span><br><span class="line">		rawdb.WriteChainConfig(db, stored, newcfg)</span><br><span class="line">		<span class="keyword">return</span> newcfg, stored, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Special case: don&#x27;t change the existing config of a non-mainnet chain if no new</span></span><br><span class="line">	<span class="comment">// config is supplied. These chains would get AllProtocolChanges (and a compat error)</span></span><br><span class="line">	<span class="comment">// if we just continued here.</span></span><br><span class="line">	<span class="keyword">if</span> genesis == <span class="literal">nil</span> &amp;&amp; stored != params.MainnetGenesisHash &#123;</span><br><span class="line">		<span class="keyword">return</span> storedcfg, stored, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check config compatibility and write the config. Compatibility errors</span></span><br><span class="line">	<span class="comment">// are returned to the caller unless we&#x27;re already at block zero.</span></span><br><span class="line">	height := rawdb.ReadHeaderNumber(db, rawdb.ReadHeadHeaderHash(db))</span><br><span class="line">	<span class="keyword">if</span> height == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> newcfg, stored, fmt.Errorf(<span class="string">&quot;missing block number for head header hash&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	compatErr := storedcfg.CheckCompatible(newcfg, *height)</span><br><span class="line">	<span class="keyword">if</span> compatErr != <span class="literal">nil</span> &amp;&amp; *height != <span class="number">0</span> &amp;&amp; compatErr.RewindTo != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> newcfg, stored, compatErr</span><br><span class="line">	&#125;</span><br><span class="line">	rawdb.WriteChainConfig(db, stored, newcfg)</span><br><span class="line">	<span class="keyword">return</span> newcfg, stored, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="https://yezzi.tech/2021/07/02/geth%E5%90%AF%E5%8A%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%883%EF%BC%89/" data-id="ckqm8q8sq000er8u77ojteles" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-geth启动代码分析（1）" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/02/geth%E5%90%AF%E5%8A%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89/">(no title)</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2021/07/02/geth%E5%90%AF%E5%8A%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89/" class="article-date"><time datetime="2021-07-02T11:06:38.678Z" itemprop="datePublished">2021-07-02</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h6 id="1-内置函数append"><a href="#1-内置函数append" class="headerlink" title="1.内置函数append"></a>1.内置函数append</h6><p>append主要用于给某个切片追加元素，如果切片长度cap足够，则直接追加，长度变长,如果空间不足，则扩展切片的长度，再加入元素</p>
<p>例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s1 := []<span class="keyword">int</span>&#123;&#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;len = %d, cap = %d\n&quot;</span>, <span class="built_in">len</span>(s1), <span class="built_in">cap</span>(s1))</span><br><span class="line">    fmt.Println(<span class="string">&quot;s1 = &quot;</span>, s1)</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//在原切片的末尾添加元素</span></span><br><span class="line">    s1 = <span class="built_in">append</span>(s1, <span class="number">1</span>)</span><br><span class="line">    s1 = <span class="built_in">append</span>(s1, <span class="number">2</span>)</span><br><span class="line">    s1 = <span class="built_in">append</span>(s1, <span class="number">3</span>)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;len = %d, cap = %d\n&quot;</span>, <span class="built_in">len</span>(s1), <span class="built_in">cap</span>(s1))</span><br><span class="line">    fmt.Println(<span class="string">&quot;s1 = &quot;</span>, s1)</span><br><span class="line"> </span><br><span class="line">    s2 := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;s2 = &quot;</span>, s2)</span><br><span class="line">    s2 = <span class="built_in">append</span>(s2, <span class="number">5</span>)</span><br><span class="line">    s2 = <span class="built_in">append</span>(s2, <span class="number">5</span>)</span><br><span class="line">    s2 = <span class="built_in">append</span>(s2, <span class="number">5</span>)</span><br><span class="line">    fmt.Println(<span class="string">&quot;s2 = &quot;</span>, s2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">len = 0, cap = 0</span><br><span class="line">s1 =  []</span><br><span class="line">len = 3, cap = 4</span><br><span class="line">s1 =  [1 2 3]</span><br><span class="line"> </span><br><span class="line">s2 =  [1 2 3]</span><br><span class="line">s2 =  [1 2 3 5 5 5]</span><br></pre></td></tr></table></figure>

<p>如果第二个参数是另一个切片，则将它里面的所有元素拷贝追加到第一个切片后边。要注意的是，这种用法函数的参数只能接收两个slice，并且末尾要加三个点</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slice := <span class="built_in">append</span>([]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;,[]<span class="keyword">int</span>&#123;<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;...)</span><br><span class="line">fmt.Println(slice) <span class="comment">//[1 2 3 4 5 6]</span></span><br></pre></td></tr></table></figure>

<p>还有种特殊用法，将字符串当作[]byte类型作为第二个参数传入</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bytes := <span class="built_in">append</span>([]<span class="keyword">byte</span>(<span class="string">&quot;hello&quot;</span>),<span class="string">&quot;world&quot;</span>...)</span><br></pre></td></tr></table></figure>

<p>·append函数返回值必须有变量接收</p>
<h6 id="2-urfave-cli：golang命令行构建工具"><a href="#2-urfave-cli：golang命令行构建工具" class="headerlink" title="2.urfave/cli：golang命令行构建工具"></a>2.urfave/cli：golang命令行构建工具</h6><p>根据源码大概讲一下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>(</span><br><span class="line"><span class="comment">// The app that holds all commands and flags.</span></span><br><span class="line">	app = utils.NewApp(gitCommit, gitDate, <span class="string">&quot;the go-ethereum command line interface&quot;</span>)</span><br><span class="line">	<span class="comment">// flags that configure the node</span></span><br><span class="line">	nodeFlags = []cli.Flag&#123;</span><br><span class="line">        。。。</span><br><span class="line">    &#125;</span><br><span class="line">    rpcFlags = []cli.Flag&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    whisperFlags = []cli.Flag&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    metricsFlags = []cli.Flag&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewApp</span><span class="params">(gitCommit, gitDate, usage <span class="keyword">string</span>)</span> *<span class="title">cli</span>.<span class="title">App</span></span> &#123;</span><br><span class="line">	app := cli.NewApp()</span><br><span class="line">	app.Name = filepath.Base(os.Args[<span class="number">0</span>])</span><br><span class="line">	app.Author = <span class="string">&quot;&quot;</span></span><br><span class="line">	app.Email = <span class="string">&quot;&quot;</span></span><br><span class="line">	app.Version = params.VersionWithCommit(gitCommit, gitDate)</span><br><span class="line">	app.Usage = usage</span><br><span class="line">	<span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Initialize the CLI app and start Geth</span></span><br><span class="line">	app.Action = geth</span><br><span class="line">	app.HideVersion = <span class="literal">true</span> <span class="comment">// we have a command to print the version</span></span><br><span class="line">	app.Copyright = <span class="string">&quot;Copyright 2013-2020 The go-ethereum Authors&quot;</span></span><br><span class="line">	app.Commands = []cli.Command&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    	sort.Sort(cli.CommandsByName(app.Commands))</span><br><span class="line"></span><br><span class="line">	app.Flags = <span class="built_in">append</span>(app.Flags, nodeFlags...)</span><br><span class="line">	app.Flags = <span class="built_in">append</span>(app.Flags, rpcFlags...)</span><br><span class="line">	app.Flags = <span class="built_in">append</span>(app.Flags, consoleFlags...)</span><br><span class="line">	app.Flags = <span class="built_in">append</span>(app.Flags, debug.Flags...)</span><br><span class="line">	app.Flags = <span class="built_in">append</span>(app.Flags, whisperFlags...)</span><br><span class="line">	app.Flags = <span class="built_in">append</span>(app.Flags, metricsFlags...)</span><br><span class="line"></span><br><span class="line">	app.Before = <span class="function"><span class="keyword">func</span><span class="params">(ctx *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> debug.Setup(ctx)</span><br><span class="line">	&#125;</span><br><span class="line">	app.After = <span class="function"><span class="keyword">func</span><span class="params">(ctx *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		debug.Exit()</span><br><span class="line">		console.Stdin.Close() <span class="comment">// Resets terminal mode.</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在该例中，首先通过new实例化一个App对象，源码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewApp creates a new cli Application with some reasonable defaults for Name,</span></span><br><span class="line"><span class="comment">// Usage, Version and Action.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewApp</span><span class="params">()</span> *<span class="title">App</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;App&#123;</span><br><span class="line">		Name:         filepath.Base(os.Args[<span class="number">0</span>]),</span><br><span class="line">		HelpName:     filepath.Base(os.Args[<span class="number">0</span>]),</span><br><span class="line">		Usage:        <span class="string">&quot;A new cli application&quot;</span>,</span><br><span class="line">		UsageText:    <span class="string">&quot;&quot;</span>,</span><br><span class="line">		Version:      <span class="string">&quot;0.0.0&quot;</span>,</span><br><span class="line">		BashComplete: DefaultAppComplete,</span><br><span class="line">		Action:       helpCommand.Action,</span><br><span class="line">		Compiled:     compileTime(),</span><br><span class="line">		Writer:       os.Stdout,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中结构体没有被定义的地方很多都有默认的初始化参数，说明一下：</p>
<p>filepath.Base : 获取path中最后一个分隔符之后的部分(不包含分隔符)</p>
<p>Action是一个空接口，要定义的是app执行的方法</p>
<p>compileTime返回一个标准包的time.Time类型，想了解可参考<a target="_blank" rel="noopener" href="https://yezzi.xyz/2019/10/08/go%E7%9A%84time%E5%8C%85%E4%BD%BF%E7%94%A8/">以下博客</a></p>
<p>其中比较重要的是Action，因为命令最后会在这里开始执行，其实已经定义好了，就是geth函数，之后再看geth函数，先写一下其他的构成。</p>
<p>Flags：</p>
<p>flag是构建启动参数，以太的Flag都写在了flags.go文件里。</p>
<p>cli包中flag的定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Flag <span class="keyword">interface</span> &#123;</span><br><span class="line">	fmt.Stringer</span><br><span class="line">	<span class="comment">// Apply Flag settings to the given flag set</span></span><br><span class="line">	Apply(*flag.FlagSet)</span><br><span class="line">	GetName() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Flag是一个接口，可以自己定义，但至少包含一个Stringer接口，和Apply，GetName两个方法</p>
<p>Stringer接口定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Stringer is implemented by any value that has a String method,</span></span><br><span class="line"><span class="comment">// which defines the ``native&#x27;&#x27; format for that value.</span></span><br><span class="line"><span class="comment">// The String method is used to print values passed as an operand</span></span><br><span class="line"><span class="comment">// to any format that accepts a string or to an unformatted printer</span></span><br><span class="line"><span class="comment">// such as Print.</span></span><br><span class="line"><span class="keyword">type</span> Stringer <span class="keyword">interface</span> &#123;</span><br><span class="line">	String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至少要有返回string的String（）方法，就可以成为Stringer接口。</p>
<p>以太坊中既有用到cli包内置的flag类型，如：StringFlag, BoolFlag, Float64Flag等，也有自定义的Flag，放在customflags.go中，如DirectoryFlag等。</p>
<p>其中cli中类似StringFlag的定义如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StringFlag is a flag with type string</span></span><br><span class="line"><span class="keyword">type</span> StringFlag <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name        <span class="keyword">string</span></span><br><span class="line">	Usage       <span class="keyword">string</span></span><br><span class="line">	EnvVar      <span class="keyword">string</span></span><br><span class="line">	FilePath    <span class="keyword">string</span></span><br><span class="line">	Required    <span class="keyword">bool</span></span><br><span class="line">	Hidden      <span class="keyword">bool</span></span><br><span class="line">	TakesFile   <span class="keyword">bool</span></span><br><span class="line">	Value       <span class="keyword">string</span></span><br><span class="line">	Destination *<span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如其说明一样，就是个带有string值的flag.</p>
<p>自定义的flag的值一般都有特殊含义和用处，DirectoryFlag定义如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DirectoryString <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DirectoryString)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(*s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DirectoryString)</span> <span class="title">Set</span><span class="params">(value <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	*s = DirectoryString(expandPath(value))</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Custom cli.Flag type which expand the received string to an absolute path.</span></span><br><span class="line"><span class="comment">// e.g. ~/.ethereum -&gt; /home/username/.ethereum</span></span><br><span class="line"><span class="keyword">type</span> DirectoryFlag <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name   <span class="keyword">string</span></span><br><span class="line">	Value  DirectoryString</span><br><span class="line">	Usage  <span class="keyword">string</span></span><br><span class="line">	EnvVar <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f DirectoryFlag)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> cli.FlagStringer(f)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// called by cli library, grabs variable from environment (if in env)</span></span><br><span class="line"><span class="comment">// and adds variable to flag set for parsing.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f DirectoryFlag)</span> <span class="title">Apply</span><span class="params">(set *flag.FlagSet)</span></span> &#123;</span><br><span class="line">	eachName(f.Name, <span class="function"><span class="keyword">func</span><span class="params">(name <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">		set.Var(&amp;f.Value, f.Name, f.Usage)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f DirectoryFlag)</span> <span class="title">GetName</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> f.Name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *DirectoryFlag)</span> <span class="title">Set</span><span class="params">(value <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	f.Value.Set(value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Commands:</p>
<p>首先Command的定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Command <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// The name of the command</span></span><br><span class="line">	Name <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// short name of the command. Typically one character (deprecated, use `Aliases`)</span></span><br><span class="line">	ShortName <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// A list of aliases for the command</span></span><br><span class="line">	Aliases []<span class="keyword">string</span></span><br><span class="line">	<span class="comment">// A short description of the usage of this command</span></span><br><span class="line">	Usage <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// Custom text to show on USAGE section of help</span></span><br><span class="line">	UsageText <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// A longer explanation of how the command works</span></span><br><span class="line">	Description <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// A short description of the arguments of this command</span></span><br><span class="line">	ArgsUsage <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// The category the command is part of</span></span><br><span class="line">	Category <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// The function to call when checking for bash command completions</span></span><br><span class="line">	BashComplete BashCompleteFunc</span><br><span class="line">	<span class="comment">// An action to execute before any sub-subcommands are run, but after the context is ready</span></span><br><span class="line">	<span class="comment">// If a non-nil error is returned, no sub-subcommands are run</span></span><br><span class="line">	Before BeforeFunc</span><br><span class="line">	<span class="comment">// An action to execute after any subcommands are run, but after the subcommand has finished</span></span><br><span class="line">	<span class="comment">// It is run even if Action() panics</span></span><br><span class="line">	After AfterFunc</span><br><span class="line">	<span class="comment">// The function to call when this command is invoked</span></span><br><span class="line">	Action <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> replace `Action: interface&#123;&#125;` with `Action: ActionFunc` once some kind</span></span><br><span class="line">	<span class="comment">// of deprecation period has passed, maybe?</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Execute this function if a usage error occurs.</span></span><br><span class="line">	OnUsageError OnUsageErrorFunc</span><br><span class="line">	<span class="comment">// List of child commands</span></span><br><span class="line">	Subcommands Commands</span><br><span class="line">	<span class="comment">// List of flags to parse</span></span><br><span class="line">	Flags []Flag</span><br><span class="line">	<span class="comment">// Treat all flags as normal arguments if true</span></span><br><span class="line">	SkipFlagParsing <span class="keyword">bool</span></span><br><span class="line">	<span class="comment">// Skip argument reordering which attempts to move flags before arguments,</span></span><br><span class="line">	<span class="comment">// but only works if all flags appear after all arguments. This behavior was</span></span><br><span class="line">	<span class="comment">// removed n version 2 since it only works under specific conditions so we</span></span><br><span class="line">	<span class="comment">// backport here by exposing it as an option for compatibility.</span></span><br><span class="line">	SkipArgReorder <span class="keyword">bool</span></span><br><span class="line">	<span class="comment">// Boolean to hide built-in help command</span></span><br><span class="line">	HideHelp <span class="keyword">bool</span></span><br><span class="line">	<span class="comment">// Boolean to hide this command from help or completion</span></span><br><span class="line">	Hidden <span class="keyword">bool</span></span><br><span class="line">	<span class="comment">// Boolean to enable short-option handling so user can combine several</span></span><br><span class="line">	<span class="comment">// single-character bool arguments into one</span></span><br><span class="line">	<span class="comment">// i.e. foobar -o -v -&gt; foobar -ov</span></span><br><span class="line">	UseShortOptionHandling <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Full name of command for help, defaults to full command name, including parent commands.</span></span><br><span class="line">	HelpName        <span class="keyword">string</span></span><br><span class="line">	commandNamePath []<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// CustomHelpTemplate the text template for the command help topic.</span></span><br><span class="line">	<span class="comment">// cli.go uses text/template to render templates. You can</span></span><br><span class="line">	<span class="comment">// render custom help text by setting this variable.</span></span><br><span class="line">	CustomHelpTemplate <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中比较重要的是：</p>
<p>name：启动的命令</p>
<p>Action：输入参数之后的运行函数</p>
<p>Flags：要解析的flag</p>
<p>现在看一下初始化区块链的命令：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">	initCommand = cli.Command&#123;</span><br><span class="line">		Action:    utils.MigrateFlags(initGenesis),</span><br><span class="line">		Name:      <span class="string">&quot;init&quot;</span>,</span><br><span class="line">		Usage:     <span class="string">&quot;Bootstrap and initialize a new genesis block&quot;</span>,</span><br><span class="line">		ArgsUsage: <span class="string">&quot;&lt;genesisPath&gt;&quot;</span>,</span><br><span class="line">		Flags: []cli.Flag&#123;</span><br><span class="line">			utils.DataDirFlag,</span><br><span class="line">		&#125;,</span><br><span class="line">		Category: <span class="string">&quot;BLOCKCHAIN COMMANDS&quot;</span>,</span><br><span class="line">		Description: <span class="string">`</span></span><br><span class="line"><span class="string">The init command initializes a new genesis block and definition for the network.</span></span><br><span class="line"><span class="string">This is a destructive action and changes the network in which you will be</span></span><br><span class="line"><span class="string">participating.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">It expects the genesis file as argument.`</span></span><br></pre></td></tr></table></figure>

<p>其utils.MigrateFlags方法可以先不管，大概就是格式化一下</p>
<p>其解析了DataDirFlag，对应着输入的命令 geth –datadir /data genesis.json init 这行启动命令中的datadir设置。</p>
<p>Before和After：</p>
<p>源码定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Before BeforeFunc</span><br><span class="line"><span class="comment">// An action to execute after any subcommands are run, but after the subcommand has finished</span></span><br><span class="line"><span class="comment">// It is run even if Action() panics</span></span><br><span class="line">After AfterFunc</span><br><span class="line"></span><br><span class="line"><span class="comment">// The action to execute when no subcommands are specified</span></span><br><span class="line"><span class="comment">// Expects a `cli.ActionFunc` but will accept the *deprecated* signature of `func(*cli.Context) &#123;&#125;`</span></span><br><span class="line"><span class="comment">// *Note*: support for the deprecated `Action` signature will be removed in a future version</span></span><br></pre></td></tr></table></figure>

<p>就是在命令构建之前和之后跑的工具</p>
<p>函数定义：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.Before = <span class="function"><span class="keyword">func</span><span class="params">(ctx *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> debug.Setup(ctx)</span><br><span class="line">&#125;</span><br><span class="line">app.After = <span class="function"><span class="keyword">func</span><span class="params">(ctx *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	debug.Exit()</span><br><span class="line">	console.Stdin.Close() <span class="comment">// Resets terminal mode.</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大概干了这几件事：</p>
<p>开始之前启动日志系统，结束之后关闭日志系统，并且重置终端。</p>
<h6 id="3-geth启动函数："><a href="#3-geth启动函数：" class="headerlink" title="3.geth启动函数："></a>3.geth启动函数：</h6><p>定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// geth is the main entry point into the system if no special subcommand is ran.</span></span><br><span class="line"><span class="comment">// It creates a default node based on the command line arguments and runs it in</span></span><br><span class="line"><span class="comment">// blocking mode, waiting for it to be shut down.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">geth</span><span class="params">(ctx *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> args := ctx.Args(); <span class="built_in">len</span>(args) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid command: %q&quot;</span>, args[<span class="number">0</span>])</span><br><span class="line">	&#125;</span><br><span class="line">	prepare(ctx)</span><br><span class="line">	node := makeFullNode(ctx)</span><br><span class="line">	<span class="keyword">defer</span> node.Close()</span><br><span class="line">	startNode(ctx, node)</span><br><span class="line">	node.Wait()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于命令行参数创建一个默认节点，并以阻塞模式运行它，等待它关闭。</p>
<h6 id="4-initGenesis方法："><a href="#4-initGenesis方法：" class="headerlink" title="4.initGenesis方法："></a>4.initGenesis方法：</h6><p>完整的定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// initGenesis will initialise the given JSON format genesis file and writes it as</span></span><br><span class="line"><span class="comment">// the zero&#x27;d block (i.e. genesis) or will fail hard if it can&#x27;t succeed.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initGenesis</span><span class="params">(ctx *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// Make sure we have a valid genesis JSON</span></span><br><span class="line">	genesisPath := ctx.Args().First()</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(genesisPath) == <span class="number">0</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;Must supply path to genesis JSON file&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	file, err := os.Open(genesisPath)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;Failed to read genesis file: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">	genesis := <span class="built_in">new</span>(core.Genesis)</span><br><span class="line">	<span class="keyword">if</span> err := json.NewDecoder(file).Decode(genesis); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;invalid genesis file: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Open an initialise both full and light databases</span></span><br><span class="line">	stack := makeFullNode(ctx)</span><br><span class="line">	<span class="keyword">defer</span> stack.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, name := <span class="keyword">range</span> []<span class="keyword">string</span>&#123;<span class="string">&quot;chaindata&quot;</span>, <span class="string">&quot;lightchaindata&quot;</span>&#125; &#123;</span><br><span class="line">		chaindb, err := stack.OpenDatabase(name, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			utils.Fatalf(<span class="string">&quot;Failed to open database: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		_, hash, err := core.SetupGenesisBlock(chaindb, genesis)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			utils.Fatalf(<span class="string">&quot;Failed to write genesis block: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		chaindb.Close()</span><br><span class="line">		log.Info(<span class="string">&quot;Successfully wrote genesis state&quot;</span>, <span class="string">&quot;database&quot;</span>, name, <span class="string">&quot;hash&quot;</span>, hash)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大概是先检查json文件格式是否存在，是否符合要求，之后构建数据库</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="https://yezzi.tech/2021/07/02/geth%E5%90%AF%E5%8A%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89/" data-id="ckqm8q8sm000ar8u70zeyebow" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-btcoin中的utxo存储" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/02/btcoin%E4%B8%AD%E7%9A%84utxo%E5%AD%98%E5%82%A8/">(no title)</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2021/07/02/btcoin%E4%B8%AD%E7%9A%84utxo%E5%AD%98%E5%82%A8/" class="article-date"><time datetime="2021-07-02T11:06:38.674Z" itemprop="datePublished">2021-07-02</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="package-blockchain"><a href="#package-blockchain" class="headerlink" title="package blockchain"></a>package blockchain</h5><p>Package blockchain implements bitcoin block handling and chain selection rules.</p>
<p>The bitcoin block handling and chain selection rules are an integral, and quite likely the most important, part of bitcoin. Unfortunately, at the time of this writing, these rules are also largely undocumented and had to be ascertained from the bitcoind source code. At its core, bitcoin is a distributed consensus of which blocks are valid and which ones will comprise the main block chain (public ledger) that ultimately determines accepted transactions, so it is extremely important that fully validating nodes agree on all rules.</p>
<h5 id="files"><a href="#files" class="headerlink" title="files"></a>files</h5><p>utxoset的操作中涉及到chainio.go upgrade.go validate.go</p>
<h5 id="const"><a href="#const" class="headerlink" title="const"></a>const</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">latestUtxoSetBucketVersion = <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>最新的UtxoSetBuket版本</p>
<h5 id="type"><a href="#type" class="headerlink" title="type"></a>type</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">utxoSetVersionKeyName = []<span class="keyword">byte</span>(<span class="string">&quot;utxosetversion&quot;</span>)</span><br><span class="line">utxoSetBucketName = []<span class="keyword">byte</span>(<span class="string">&quot;utxosetv2&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>leveldb中存储utxoVersion的Key的名字</p>
<p>leveldb中存储utxoBuket的Key的名字</p>
<h5 id="func-dbFetchUtxoEntryByHash"><a href="#func-dbFetchUtxoEntryByHash" class="headerlink" title="func dbFetchUtxoEntryByHash"></a>func dbFetchUtxoEntryByHash</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dbFetchUtxoEntryByHash</span><span class="params">(dbTx database.Tx, hash *chainhash.Hash)</span> <span class="params">(*UtxoEntry, error)</span></span> </span><br></pre></td></tr></table></figure>

<p>用给定的hash取得对应的utxo，使用光标实现（为实现最效率），若没有则返回null</p>
<h5 id="func-dbFetchUtxoEntry"><a href="#func-dbFetchUtxoEntry" class="headerlink" title="func dbFetchUtxoEntry"></a>func dbFetchUtxoEntry</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dbFetchUtxoEntry</span><span class="params">(dbTx database.Tx, outpoint wire.OutPoint)</span> <span class="params">(*UtxoEntry, error)</span></span></span><br></pre></td></tr></table></figure>

<p>用数据库中已经存在的交易从utxo中取出交易的输出</p>
<h5 id="func-dbPutUtxoView"><a href="#func-dbPutUtxoView" class="headerlink" title="func dbPutUtxoView"></a>func dbPutUtxoView</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dbPutUtxoView</span><span class="params">(dbTx database.Tx, view *UtxoViewpoint)</span> <span class="title">error</span></span> </span><br><span class="line">	<span class="keyword">for</span> outpoint, entry := <span class="keyword">range</span> view.entries &#123;</span><br><span class="line">		...</span><br><span class="line">        <span class="comment">// No need to update the database if the entry was not modified.</span></span><br><span class="line">    &#125;</span><br><span class="line">        <span class="comment">// Remove the utxo entry if it is spent.</span></span><br><span class="line">		...</span><br><span class="line">        <span class="comment">// Serialize and store the utxo entry.</span></span><br><span class="line">...</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> The key is intentionally not recycled here since the</span></span><br><span class="line">		<span class="comment">// database interface contract prohibits modifications.  It will</span></span><br><span class="line">		<span class="comment">// be garbage collected normally when the database is done with</span></span><br><span class="line">		<span class="comment">// it.</span></span><br></pre></td></tr></table></figure>

<p>dbPutUtxoView使用现有的数据库的交易，根据提供的utxo视图内容和状态，更新数据库中的utxo集。特别是，只有标记为修改的条目才会写入数据库。</p>
<p>这个地方比较重要，基本上就是根据tx把把utxo集一顿修改，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BlockChain)</span> <span class="title">createChainState</span><span class="params">()</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>

<p>建立创世区块，初始化各种数据库Bucket，在这个过程中调用了dbPutVersion(dbTx,utxoSetVersionKeyName,latestUtxoSetBucketVersion)函数和CreateBucket(utxoSetBucketName)存储utxo集的元数据和utxo集数据库Bucket</p>
<h5 id="func-upgradeUtxoSetToV2"><a href="#func-upgradeUtxoSetToV2" class="headerlink" title="func upgradeUtxoSetToV2"></a>func upgradeUtxoSetToV2</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">upgradeUtxoSetToV2</span><span class="params">(db database.DB, interrupt &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>

<p>批量将utxo集条目从版本1迁移到2。</p>
<h5 id="func-b-BlockChain-maybeUpgradeDbBuckets"><a href="#func-b-BlockChain-maybeUpgradeDbBuckets" class="headerlink" title="func (b *BlockChain) maybeUpgradeDbBuckets"></a>func (b *BlockChain) maybeUpgradeDbBuckets</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (b *BlockChain) maybeUpgradeDbBuckets(interrupt &lt;-chan struct&#123;&#125;) error</span><br></pre></td></tr></table></figure>

<p>检查此包里buckets的database是否为最新，并升级到最新</p>
<h5 id="func-b-BlockChain-checkConnectBlock"><a href="#func-b-BlockChain-checkConnectBlock" class="headerlink" title="func (b *BlockChain) checkConnectBlock"></a>func (b *BlockChain) checkConnectBlock</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (b *BlockChain) checkConnectBlock(node *blockNode, block *btcutil.Block, view *UtxoViewpoint, stxos *[]SpentTxOut) error</span><br></pre></td></tr></table></figure>


      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="https://yezzi.tech/2021/07/02/btcoin%E4%B8%AD%E7%9A%84utxo%E5%AD%98%E5%82%A8/" data-id="ckqm8q8se0005r8u73jdz56s1" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-bloom过滤器代码分析" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/02/bloom%E8%BF%87%E6%BB%A4%E5%99%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">(no title)</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2021/07/02/bloom%E8%BF%87%E6%BB%A4%E5%99%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" class="article-date"><time datetime="2021-07-02T11:06:38.673Z" itemprop="datePublished">2021-07-02</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h6 id="布隆过滤器简介"><a href="#布隆过滤器简介" class="headerlink" title="布隆过滤器简介"></a>布隆过滤器简介</h6><p>Bloom filter(布鲁姆过滤器)是用于测试元素成员资格的空间高效概率数据结构。数据结构以牺牲规定的假阳性率为代价实现了巨大的数据压缩。</p>
<h6 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h6><p>一个Bloom过滤器作为一个m位的数组全部设置为0。选择一组k个随机散列函数，在Bloom过滤器中添加元素时，元素将分别进行哈希散列，而对于每个k个输出，该索引处的相应的Bloom过滤器位将被设置为1。通过使用与之前相同的散列函数来完成Bloom过滤器的查询。如果在bloom过滤器中访问的所有k个比特被设置为1，则这很可能表明该元素位于该集合中。删除元素只能通过废除Bloom过滤器并从头重新创建来完成。</p>
<p>Bloom过滤器是由底层数组和哈希函数组合在一起工作的，根据对误报率要求的不同，可以选择一个哈希函数，也可以选2个、3个，一般情况下选3个。与哈希表不同，为节省空间，Bloom过滤器的底层数组的每一位是一个比特，1表示有映射，0表示无映射。数组的长度与问题规模、哈希函数、误报率等因素有关，根据数据集规模的不同，可选用适当的哈希函数与适合的数组大小。因为具体问题的不同，很难说那种实现是最好的。</p>
<h6 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h6><p>下面举例说明Bloom过滤器的工作过程。</p>
<p> <img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS83LzkvMTZiZDVjMjAzMzU1ZTMzZg" alt="img"> </p>
<p>数据集{x,y,z}，底层数组长度m=18，初始值全部为0，哈希函数个数k=3，分别为H1、H2 、H3。</p>
<p>首先把数据集的每个元素分别通过3个不同的哈希函数映射到底层数组中，将数组中对应位置的值置为1。可以看到有哈希碰撞发生，这里不用解决哈希碰撞。</p>
<p>当要判断一个元素是否在数据集中时，例如w，则依次计算3个哈希值，找数组中的映射值，如果映射值有一个为0则，元素不存在数据集中，如果3个对应映射值全部为1，则元素很大概率在数据集中，不能完全确定（因为哈希碰撞的存在）。图中，元素w的其中一个哈希映射为0，所以w一定不在数据集中。</p>
<h6 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h6><p>因为哈希碰撞的原因，底层数组对应映射值为1，有可能是其他元素与要查找的元素发生碰撞，实际上，该元素并不存在在数据集中。所以Bloom过滤器存在误报率。</p>
<p>Bloom过滤器，只有插入、查找操作，没有删除操作。</p>
<h6 id="以太坊中的布隆过滤器"><a href="#以太坊中的布隆过滤器" class="headerlink" title="以太坊中的布隆过滤器"></a>以太坊中的布隆过滤器</h6><p><strong>1.其中的两个带有bloom的结构：</strong></p>
<p>收据中的布隆过滤器是所有日志信息的布隆过滤器的并集</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Receipt <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Consensus fields: These fields are defined by the Yellow Paper</span></span><br><span class="line">	PostState         []<span class="keyword">byte</span> <span class="string">`json:&quot;root&quot;`</span><span class="comment">//现在是0（属于）B256,之前是交易前的状态跟</span></span><br><span class="line">	Status            <span class="keyword">uint64</span> <span class="string">`json:&quot;status&quot;`</span><span class="comment">//交易的状态码</span></span><br><span class="line">	CumulativeGasUsed <span class="keyword">uint64</span> <span class="string">`json:&quot;cumulativeGasUsed&quot; gencodec:&quot;required&quot;`</span><span class="comment">//包含交易数据的区块中当交易发生后的累积 gas 使用量</span></span><br><span class="line">	Bloom             Bloom  <span class="string">`json:&quot;logsBloom&quot;         gencodec:&quot;required&quot;`</span><span class="comment">//由这些日志信息构成的布隆过滤器</span></span><br><span class="line">	Logs              []*Log <span class="string">`json:&quot;logs&quot;              gencodec:&quot;required&quot;`</span><span class="comment">//日志集合</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Implementation fields: These fields are added by geth when processing a transaction.//执行领域，在执行交易时被geth添加，存储在区块链数据库</span></span><br><span class="line">	<span class="comment">// They are stored in the chain database.</span></span><br><span class="line">	TxHash          common.Hash    <span class="string">`json:&quot;transactionHash&quot; gencodec:&quot;required&quot;`</span></span><br><span class="line">	ContractAddress common.Address <span class="string">`json:&quot;contractAddress&quot;`</span></span><br><span class="line">	GasUsed         <span class="keyword">uint64</span>         <span class="string">`json:&quot;gasUsed&quot; gencodec:&quot;required&quot;`</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//Inclusion information: These fields provide information about the inclusion of the</span></span><br><span class="line">	<span class="comment">//transaction corresponding to this receipt.//提供与此收据有关的交易记录</span></span><br><span class="line">	BlockHash        common.Hash <span class="string">`json:&quot;blockHash,omitempty&quot;`</span></span><br><span class="line">	BlockNumber      *big.Int    <span class="string">`json:&quot;blockNumber,omitempty&quot;`</span></span><br><span class="line">	TransactionIndex <span class="keyword">uint</span>        <span class="string">`json:&quot;transactionIndex&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>区块中的布隆过滤器是所有收据中的布隆过滤器的并集</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Header represents a block header in the Ethereum blockchain.</span></span><br><span class="line"><span class="keyword">type</span> Header <span class="keyword">struct</span> &#123;</span><br><span class="line">	ParentHash  common.Hash    <span class="string">`json:&quot;parentHash&quot;       gencodec:&quot;required&quot;`</span> <span class="comment">//父区块头的kec256位哈希</span></span><br><span class="line">	UncleHash   common.Hash    <span class="string">`json:&quot;sha3Uncles&quot;       gencodec:&quot;required&quot;`</span> <span class="comment">//叔块哈希</span></span><br><span class="line">	Coinbase    common.Address <span class="string">`json:&quot;miner&quot;            gencodec:&quot;required&quot;`</span> <span class="comment">//矿工</span></span><br><span class="line">	Root        common.Hash    <span class="string">`json:&quot;stateRoot&quot;        gencodec:&quot;required&quot;`</span> <span class="comment">//状态树树根</span></span><br><span class="line">	TxHash      common.Hash    <span class="string">`json:&quot;transactionsRoot&quot; gencodec:&quot;required&quot;`</span> <span class="comment">//交易树树根</span></span><br><span class="line">	ReceiptHash common.Hash    <span class="string">`json:&quot;receiptsRoot&quot;     gencodec:&quot;required&quot;`</span> <span class="comment">//收据树树根</span></span><br><span class="line">	Bloom       Bloom          <span class="string">`json:&quot;logsBloom&quot;        gencodec:&quot;required&quot;`</span> <span class="comment">//所有交易的收据数据中可索引信息（产生日志的地址和日志主题）组成的Bloom过滤器</span></span><br><span class="line">	Difficulty  *big.Int       <span class="string">`json:&quot;difficulty&quot;       gencodec:&quot;required&quot;`</span> <span class="comment">//区快难度水平</span></span><br><span class="line">	Number      *big.Int       <span class="string">`json:&quot;number&quot;           gencodec:&quot;required&quot;`</span> <span class="comment">//祖先的数量，创世是0</span></span><br><span class="line">	GasLimit    <span class="keyword">uint64</span>         <span class="string">`json:&quot;gasLimit&quot;         gencodec:&quot;required&quot;`</span> <span class="comment">//gas开支上限</span></span><br><span class="line">	GasUsed     <span class="keyword">uint64</span>         <span class="string">`json:&quot;gasUsed&quot;          gencodec:&quot;required&quot;`</span> <span class="comment">//用掉的gas之和</span></span><br><span class="line">	Time        <span class="keyword">uint64</span>         <span class="string">`json:&quot;timestamp&quot;        gencodec:&quot;required&quot;`</span> <span class="comment">//unix时间戳</span></span><br><span class="line">	Extra       []<span class="keyword">byte</span>         <span class="string">`json:&quot;extraData&quot;        gencodec:&quot;required&quot;`</span> <span class="comment">//32字节以内的任意数据</span></span><br><span class="line">	MixDigest   common.Hash    <span class="string">`json:&quot;mixHash&quot;`</span>								 <span class="comment">//kec256哈希值与nonce一起证明当前区块承载了足够的计算量</span></span><br><span class="line">	Nonce       BlockNonce     <span class="string">`json:&quot;nonce&quot;`</span>								 <span class="comment">//64位的值，用来与mixhash一起证明当前区块承载了足够多的的计算量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.布隆过滤器的构成</strong></p>
<p><img src="./picture/6.png"></p>
<p><strong>3.布隆过滤器的实现</strong></p>
<p>在NewBlock函数中有一段对收据进行收据树构建和布隆过滤器构建的操作</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(receipts) == <span class="number">0</span> &#123;</span><br><span class="line">	b.header.ReceiptHash = EmptyRootHash</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	b.header.ReceiptHash = DeriveSha(Receipts(receipts))</span><br><span class="line">	b.header.Bloom = CreateBloom(receipts)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中DeriveSha已经在Block模块讲过，遍历收据树/交易树构建mpt树并取树根哈希。</p>
<p>涉及到的Bloom调用关系：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*/core/types/bloom9.go*/</span></span><br><span class="line"><span class="comment">//这个作用是遍历收据，将收据中的日志信息构建布隆过滤器，求并集。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateBloom</span><span class="params">(receipts Receipts)</span> <span class="title">Bloom</span></span> &#123;</span><br><span class="line">	bin := <span class="built_in">new</span>(big.Int)</span><br><span class="line">	<span class="keyword">for</span> _, receipt := <span class="keyword">range</span> receipts &#123;</span><br><span class="line">		bin.Or(bin, LogsBloom(receipt.Logs))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> BytesToBloom(bin.Bytes())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//这个函数是具体对收据中的logs求布隆过滤器，这个函数有两层循环，先遍历每一个log，取出其中的地址执行bloom9过滤器函数得到结果，再对每一个log中的topic循环进行bloom9过滤得到结果，将所有过滤后的布隆过滤器结果保存并返回</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LogsBloom</span><span class="params">(logs []*Log)</span> *<span class="title">big</span>.<span class="title">Int</span></span> &#123;</span><br><span class="line">	bin := <span class="built_in">new</span>(big.Int)</span><br><span class="line">	<span class="keyword">for</span> _, log := <span class="keyword">range</span> logs &#123;</span><br><span class="line">		bin.Or(bin, bloom9(log.Address.Bytes()))</span><br><span class="line">		<span class="keyword">for</span> _, b := <span class="keyword">range</span> log.Topics &#123;</span><br><span class="line">			bin.Or(bin, bloom9(b[:]))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bin</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//把输入映射到digest中的三个位置</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bloom9</span><span class="params">(b []<span class="keyword">byte</span>)</span> *<span class="title">big</span>.<span class="title">Int</span></span> &#123;</span><br><span class="line">	b = crypto.Keccak256(b)<span class="comment">//对信息生成一个256位的哈希值，返回32字节</span></span><br><span class="line"></span><br><span class="line">	r := <span class="built_in">new</span>(big.Int)<span class="comment">//最后要返回的bloomfilter，先初始化为零</span></span><br><span class="line">    <span class="comment">//对b字节中的前六个字节，每两个字节组成一组，拼接在一起，进行和2047的位层面的and操作,也就是对2048取余，得到位于0-2047区间的一个数，因为bloomfilter的长度是2048位。循环的第一行取t为1，最后一行把1左移b这么多位，然后合并到上一轮得到的bloomfilter里，经过三轮，把三个位置置位1后返回bloomfilter</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">6</span>; i += <span class="number">2</span> &#123;</span><br><span class="line">		t := big.NewInt(<span class="number">1</span>)</span><br><span class="line">		b := (<span class="keyword">uint</span>(b[i+<span class="number">1</span>]) + (<span class="keyword">uint</span>(b[i]) &lt;&lt; <span class="number">8</span>)) &amp; <span class="number">2047</span></span><br><span class="line">		r.Or(r, t.Lsh(t, b))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//查询bin这个bloom里是否含有这个topic，先用bloom9对topic转换成bytes slice，之后先执行bloom和topic构成的临时bloomfilter的交集操作，看和topic的bloomfilter是否相等</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BloomLookup</span><span class="params">(bin Bloom, topic bytesBacked)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	bloom := bin.Big()</span><br><span class="line">	cmp := bloom9(topic.Bytes())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bloom.And(bloom, cmp).Cmp(cmp) == <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Bloom9函数（布隆过滤器的原始实现）：</p>
<p><a href="./golang%E5%9F%BA%E7%A1%80%EF%BC%9Abig%E5%8C%85%E5%92%8C%E4%BD%8D%E8%BF%90%E7%AE%97.md">(附：big包、多种int类型和位运算简介)</a></p>
<p><img src="./picture/7.png"></p>
<p><img src="./picture/8.png"></p>
<p>实际检索时，虽然bloomfilter是用big.Int存储的，但int包中比较两个数和判断包含关系时用的是位运算，所以虽然难以显示位的形式显示bloomfilter，但用big.Int形式存储bloomfilter恰到好处。</p>
<p>测试代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/imroc/biu&quot;</span></span><br><span class="line">	<span class="string">&quot;math/big&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bloom9</span><span class="params">()</span> *<span class="title">big</span>.<span class="title">Int</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	b := []<span class="keyword">byte</span>(<span class="string">&quot;3A72978C1084E2d44D1Fa06DdC4A2d57&quot;</span>)</span><br><span class="line">	fmt.Println()</span><br><span class="line">	fmt.Println(<span class="built_in">len</span>(b)==<span class="number">32</span>)</span><br><span class="line">	fmt.Println(b)</span><br><span class="line">	b1 := <span class="keyword">uint</span>(b[<span class="number">0</span>])</span><br><span class="line">	b2 := <span class="keyword">uint</span>(b[<span class="number">1</span>])</span><br><span class="line">	fmt.Println(<span class="keyword">uint</span>(b[<span class="number">0</span>]),<span class="keyword">uint</span>(b[<span class="number">1</span>]))</span><br><span class="line">	fmt.Println(biu.ToBinaryString(b1))</span><br><span class="line">	fmt.Println(biu.ToBinaryString(b2))</span><br><span class="line">	fmt.Println()</span><br><span class="line"></span><br><span class="line">	r := <span class="built_in">new</span>(big.Int)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">6</span>; i += <span class="number">2</span> &#123;</span><br><span class="line"></span><br><span class="line">		t := big.NewInt(<span class="number">1</span>)</span><br><span class="line">		fmt.Println(<span class="string">&quot;t:&quot;</span>,t)</span><br><span class="line">		tmp := (<span class="keyword">uint</span>(b[i+<span class="number">1</span>]) + (<span class="keyword">uint</span>(b[i]) &lt;&lt; <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">		b := (<span class="keyword">uint</span>(b[i+<span class="number">1</span>]) + (<span class="keyword">uint</span>(b[i]) &lt;&lt; <span class="number">8</span>)) &amp; <span class="number">2047</span></span><br><span class="line">		fmt.Println(<span class="string">&quot;进行+操作后的uint数字&quot;</span>,tmp)</span><br><span class="line">		fmt.Println(<span class="string">&quot;进行+操作后的位表示&quot;</span>,biu.ToBinaryString(tmp))</span><br><span class="line">		fmt.Println(<span class="string">&quot;2047的位表示：&quot;</span>,biu.ToBinaryString(<span class="keyword">uint</span>(<span class="number">2047</span>)))</span><br><span class="line">		fmt.Println(<span class="string">&quot;和2047进行与操作后： &quot;</span>,biu.ToBinaryString(b))</span><br><span class="line"></span><br><span class="line">		r.Or(r, t.Lsh(t, b))</span><br><span class="line">		fmt.Println(<span class="string">&quot;r: &quot;</span>,r)</span><br><span class="line">		fmt.Println()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//进行布隆过滤器实操，假设输入的是32字节的topic类型 0xabcd68033A72978C1084E2d44D1Fa06DdC4A2d57</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	bloom9()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">[51 65 55 50 57 55 56 67 49 48 56 52 69 50 100 52 52 68 49 70 97 48 54 68 100 67 52 65 50 100 53 55]</span><br><span class="line">51 65</span><br><span class="line">[00000000 00000000 00000000 00000000 00000000 00000000 00000000 00110011]</span><br><span class="line">[00000000 00000000 00000000 00000000 00000000 00000000 00000000 01000001]</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line">t: 1</span><br><span class="line">进行+操作后的uint数字 13121</span><br><span class="line">进行+操作后的位表示 [00000000 00000000 00000000 00000000 00000000 00000000 00110011 01000001]</span><br><span class="line">2047的位表示： [00000000 00000000 00000000 00000000 00000000 00000000 00000111 11111111]</span><br><span class="line">和2047进行与操作后：  [00000000 00000000 00000000 00000000 00000000 00000000 00000011 01000001]</span><br><span class="line">r:  57277807836949922408837567867349676981443478344341305058882899404622128010705808318690568531649256750858719018437999440148793721514146753400890052083129159241025748615958424204533602522957957552490080016463490494951861107213475167230717574212948590592</span><br><span class="line"></span><br><span class="line">t: 1</span><br><span class="line">进行+操作后的uint数字 14130</span><br><span class="line">进行+操作后的位表示 [00000000 00000000 00000000 00000000 00000000 00000000 00110111 00110010]</span><br><span class="line">2047的位表示： [00000000 00000000 00000000 00000000 00000000 00000000 00000111 11111111]</span><br><span class="line">和2047进行与操作后：  [00000000 00000000 00000000 00000000 00000000 00000000 00000111 00110010]</span><br><span class="line">r:  314233160182030736919751647047283290074158037244463871560980478788853316627874708750078214927865002494324613164753036777329719824205199439641013233466169838342774747631715248648272107024198456863680846183894703107928994710112002923069118082222231268172316199217641800603788442740611117876684040992433870125828443074830556275747757471100557196447769555568234660880002738894725057172944300128715707792997028959370378366499845797661040563264104785434051255235127701702797547234944876551769642325371880354786760476631936450661453927975692274855249413926813696</span><br><span class="line"></span><br><span class="line">t: 1</span><br><span class="line">进行+操作后的uint数字 14647</span><br><span class="line">进行+操作后的位表示 [00000000 00000000 00000000 00000000 00000000 00000000 00111001 00110111]</span><br><span class="line">2047的位表示： [00000000 00000000 00000000 00000000 00000000 00000000 00000111 11111111]</span><br><span class="line">和2047进行与操作后：  [00000000 00000000 00000000 00000000 00000000 00000000 00000001 00110111]</span><br><span class="line">r:  314233160182030736919751647047283290074158037244463871560980478788853316627874708750078214927865002494324613164753036777329719824205199439641013233466169838342774747631715248648272107024198456863680846183894703107928994710112002923069118082222231268172316199217641800603788442740611117876684040992433870125828443074830556275747757471100557196447769555568234660880002738894725057172944300128715707792997028959370378366499845797661040563264104785434051255235127705874647226767972381229546412187778354188194030704469377753477094205748594190168823677524639744</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="https://yezzi.tech/2021/07/02/bloom%E8%BF%87%E6%BB%A4%E5%99%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" data-id="ckqm8q8sg0006r8u7gfep962n" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-DoERS_note" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/02/DoERS_note/">(no title)</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2021/07/02/DoERS_note/" class="article-date"><time datetime="2021-07-02T11:06:38.670Z" itemprop="datePublished">2021-07-02</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="As-Strong-As-Its-Weakest-Link-How-to-Break-Blockchain-DApps-at-RPC-Service"><a href="#As-Strong-As-Its-Weakest-Link-How-to-Break-Blockchain-DApps-at-RPC-Service" class="headerlink" title="As Strong As Its Weakest Link: How to Break Blockchain DApps at RPC Service"></a>As Strong As Its Weakest Link: How to Break Blockchain DApps at RPC Service</h1><h2 id="overview"><a href="#overview" class="headerlink" title="overview"></a>overview</h2><p>Blockchain remote procedure call (RPC) services emerge as an  intermediary connecting the DApps to a blockchain network.</p>
<p>Conduct a systematic measurement study on nine real-world  RPC services which control most DApp clients’ connection  to the Ethereum mainnet</p>
<p>Discover the previously unknown behaviors: load balancing and gas limiting; strategies are proposed to evade the protection</p>
<p>The effectiveness of DoERS attacks on deployed  RPC services with minimal service interruption</p>
<p>Propose mitigation techniques against DoERS without  dropping service usability, via unpredictable load balancing,  performance anomaly detection, and others</p>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><h3 id="DApps"><a href="#DApps" class="headerlink" title="DApps"></a><em>DApps</em></h3><p>“<strong>decentralized applications running atop operational blockchain systems</strong>“</p>
<ul>
<li>decentralized finances (DeFi)</li>
<li>online gaming</li>
<li>information-security infrastructures</li>
<li>…</li>
</ul>
<h3 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a><em>RPC</em></h3><p><em><strong>Remote Procedure Call</strong></em> service that translates the clients’ requests to cryptocurrency transactions or<br>queries to a blockchain P2P network<img src="/img/1.png" alt="1"></p>
<h4 id="category"><a href="#category" class="headerlink" title="category"></a>category</h4><p>maintained directly by the DApp owner (i.e., an in-house RPC node)</p>
<p>a set of nodes hosted by a third party (i.e., a third-party RPC service)</p>
<h4 id="providers"><a href="#providers" class="headerlink" title="providers"></a>providers</h4><p>Majority</p>
<ul>
<li>nine service providers supporting the Ethereum’s JSON-RPC interface (<strong>evaluated in this work</strong>) </li>
<li>blockchain.info  : Bitcoin’s JSON-RPC</li>
<li>dfuse.io: EOSIO’s Chain API</li>
<li>greymass.com : EOSIO’s Chain API</li>
<li>stellar.org: Stellar Horizon</li>
</ul>
<h4 id="shortcoming"><a href="#shortcoming" class="headerlink" title="shortcoming"></a>shortcoming</h4><p>less decentralized: one to hundreds of nodes, DoS attack could lead to the collapse of the<br>whole DApp ecosystem</p>
<p>Harms:</p>
<ul>
<li>Bitcoin exchanges</li>
<li>mining pools</li>
<li>launched against a victim RPC service: allowing a service competitor to steal customers from the victim</li>
</ul>
<p> For instance:</p>
<ul>
<li>registering an Ethereum domain; purchasing a CryptoKitty: </li>
</ul>
<p>delay others’ bidding transactions and win the auction at an unfairly low price</p>
<ul>
<li>hash-time-lock contract (HTLC):</li>
</ul>
<p>defer the withdrawal of the deposit after the expiration of the lock (so-called grieving [51]) by denying the RPC service used by the withdrawal, thus retaining the deposit.</p>
<h2 id="DoERS"><a href="#DoERS" class="headerlink" title="DoERS"></a>DoERS</h2><p>Menace of DoERS</p>
<p>Measurement and findings</p>
<p>Attacks</p>
<p>Mitigation</p>
<p>the research formulation is presented in <strong>Section III</strong></p>
<p>measurement of DoERS exploitability among RPC services are presented in <strong>Section IV</strong></p>
<p>Related works are presented in <strong>Section VII</strong> </p>
<p>responsible disclosure in <strong>Section VIII</strong> </p>
<p>conclusion in <strong>Section IX</strong></p>
<h3 id="Threat-model"><a href="#Threat-model" class="headerlink" title="Threat model"></a><em>Threat model</em></h3><p><strong>an attacker:</strong> send crafted RPC requests to deny the RPC service</p>
<p><strong>an Ethereum RPC service</strong>: a single Ethereum node or a group of Ethereum nodes behind a frontend infrastructure to accept RPC requests</p>
<p><strong>a benign client</strong>: send regular RPC requests</p>
<h3 id="Description-of-DoERS"><a href="#Description-of-DoERS" class="headerlink" title="Description of DoERS"></a><em>Description of DoERS</em></h3><p>Constructed based on an exploitable <strong>smart contract</strong> that contains <strong>resource-consuming procedures</strong></p>
<p>Exploitable functions that aim at <strong>depleting CPU, memory and IO resources</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">contract DoERS-C &#123;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">exhaustCPU</span>(<span class="params">uint256 payload_size1</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>)</span>&#123;</span><br><span class="line"> bytes32 target=<span class="number">0xf</span>...f;</span><br><span class="line"> <span class="keyword">for</span> (uint256 i=<span class="number">0</span>; i&lt;payload_size1; ++i)&#123;</span><br><span class="line"> target = keccak256(abi.encodePacked(target));&#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="literal">true</span>;&#125;</span><br><span class="line"> bytes32[] storage;</span><br><span class="line">    </span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">exhaustIO</span>(<span class="params">uint256 payload_size1</span>) <span class="title">public</span> <span class="title">returns</span>(<span class="params">bool</span>)</span>&#123;</span><br><span class="line"> <span class="keyword">for</span> (uint256 j=<span class="number">0</span>; j&lt;payload_size2; ++j) &#123;</span><br><span class="line"> storage.push(<span class="number">0xf</span>...f);&#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="literal">true</span>;&#125;</span><br><span class="line">    </span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">exhaustMem</span>(<span class="params">uint256 payload_size3</span>) <span class="title">pure</span> <span class="title">public</span> <span class="title">returns</span>(<span class="params">bool</span>) </span>&#123;</span><br><span class="line"> bytes32[] memory mem = <span class="keyword">new</span> bytes32[](payload_size3);</span><br><span class="line"> mem[payload_size3-<span class="number">1</span>] = <span class="number">0xf</span>...f;<span class="comment">//&quot;CODECOPY&quot; allocate memory</span></span><br><span class="line"> <span class="keyword">return</span> <span class="literal">true</span>;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>Executed in two steps: </p>
<ol>
<li>Client deploys the DoERS-C smart contract to Ethereum.</li>
<li>Send one or multiple eth_call RPCs to the victim node to trigger one of the three exhaustXX functions in DoERS-C</li>
</ol>
<p>Limitation: the configurations of Ethereum nodes may thwart the above basic attack: Ethereum’s Gas<br>limit, timeout, rate limiting, load balancing, as well as other unknown mechanisms inside the black box RPC services.</p>
<h2 id="Measurement-of-DoERS-exploitability"><a href="#Measurement-of-DoERS-exploitability" class="headerlink" title="Measurement of DoERS exploitability"></a>Measurement of DoERS exploitability</h2><h3 id="load-balancer"><a href="#load-balancer" class="headerlink" title="load balancer"></a><em>load balancer</em></h3><p><strong>Measurement mechanisms</strong></p>
<p>First, send an orphan transaction with nonce+ 2 and gas price to a target RPC service</p>
<p>Second, send the second orphan transaction, with the same nonce+ 2 but paying gas price−1. If the second transaction fails, no load valancing is detected.</p>
<p>Third, send RPC queries to eth_getTransactionByHash(txHash), after waiting for a time period, sends another one. If both return successfully, no load balancing is detected.</p>
<p>Forth, send getBlockNumber RPC requests, if  anomaly detected (one smaller than last one), load balancing detected.</p>
<p><strong>Results</strong></p>
<p><img src="/img/2.png" alt="2"></p>
<ul>
<li>Type i) No load balancing </li>
<li>Type ii-a) No load balancing detected when RPC queries are sent with the same API key and from different IPs</li>
<li>Type ii-b) No load balancing detected when RPC queries are sent from the same IP but with different API keys;</li>
<li>Type iii)  Comprehensive load balancing detected</li>
</ul>
<p><strong>Attack Strategies Evading Load Balancer</strong></p>
<ul>
<li>Type i) straightforward way</li>
<li>Type ii-a) use same API Keys</li>
<li>Type ii-b)  set up a token faucet, giving away free M-Tokens, internally calls exhaustXX</li>
<li>Type iii)  “flash attack” (e.g., one minute for ServiceX6)</li>
</ul>
<h3 id="Gas-Limits"><a href="#Gas-Limits" class="headerlink" title="Gas Limits"></a><em>Gas Limits</em></h3><p><strong>Measurement mechanisms</strong></p>
<p>First, the program starts with an initial guess on the target arrayLength value</p>
<p>Then grows the guess exponentially until the first exception is observed.</p>
<p>Second, binary-search the Gas-limit corresponding value of arrayLength, gain target value V</p>
<p>Finally, run estimateGas() with function exhaustMem under V </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">float <span class="function"><span class="title">rpc_gasLimit</span>(<span class="params">IP rpcNode</span>)</span>&#123;</span><br><span class="line"> int lengthLower=<span class="number">0</span>; int lengthUpper=<span class="number">500</span>;<span class="comment">//0/500 block gas</span></span><br><span class="line"> <span class="keyword">while</span> (lengthUpper - lengthLower &gt; <span class="number">1</span>)&#123;</span><br><span class="line"> arrayLength = (lengthLower + lengthUpper) / <span class="number">2</span>;</span><br><span class="line"> <span class="keyword">try</span>&#123;</span><br><span class="line"> rpcNode.eth_call(exhaustMem,arrayLength);</span><br><span class="line"> &#125; (Exception e) &#123;</span><br><span class="line"> <span class="keyword">if</span>(e instanceOf OutofGasException)&#123;</span><br><span class="line"> lengthUpper = arrayLength;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123; <span class="comment">//no gas limits</span></span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> lengthLower = arrayLength;&#125;&#125;</span><br><span class="line"> <span class="keyword">return</span> localNode.estmateGas(exhaustMem,arrayLength);&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Results</strong></p>
<p>four out of nine services configure the Gas limit: ServiceX3/ServiceX6/ServiceX9/ServiceX8 respectively set Gas limit at 50/10/5/1.5 block gas</p>
<p><strong>Attack Strategies Evading Gas Limit</strong></p>
<p>send multiple DoERS requests at a sufficiently high rate</p>
<h2 id="COUNTERMEASURE"><a href="#COUNTERMEASURE" class="headerlink" title="COUNTERMEASURE"></a><strong>COUNTERMEASURE</strong></h2><h3 id="Known-Countermeasures"><a href="#Known-Countermeasures" class="headerlink" title="Known Countermeasures"></a><em>Known Countermeasures</em></h3><h4 id="Gas-Limits-1"><a href="#Gas-Limits-1" class="headerlink" title="Gas Limits"></a>Gas Limits</h4><p>necessary but not sufficient</p>
<h4 id="Contract-Banning"><a href="#Contract-Banning" class="headerlink" title="Contract Banning"></a>Contract Banning</h4><p>upload a smart contract at the invocation time of eth_call</p>
<h3 id="Proposed-Countermeasures"><a href="#Proposed-Countermeasures" class="headerlink" title="Proposed Countermeasures"></a><em>Proposed Countermeasures</em></h3><p><strong>The root cause of DoERS</strong> : an <strong>open-membership</strong> RPC service that allows for <strong>free execution</strong> of <strong>arbitrary smart contract programs</strong> on its peers <strong>shared</strong> by different DApps</p>
<p><strong>Change root condition:</strong> </p>
<ul>
<li>removing open-membership (e.g., by authenticating DApp clients based on their true identities)</li>
<li>charging the contract execution triggered by eth_call</li>
<li>limiting the computation expressiveness (e.g.,prohibiting loops)</li>
<li>avoiding any sharing of a RPC node among DApps</li>
<li>etc</li>
</ul>
<p><strong>Goal:</strong> encounter a fundamental trade-off between DoERS security and service usability</p>
<h4 id="Unpredictable-yet-consistency-preserving-load-balancing"><a href="#Unpredictable-yet-consistency-preserving-load-balancing" class="headerlink" title="Unpredictable yet consistency-preserving load balancing"></a>Unpredictable yet consistency-preserving load balancing</h4><p>one balancer handles only transactions while the other forwards only RPC queries:</p>
<p><strong>load balancer</strong> : nternally maintain a secret true-random number or the current workload that decides the destination backend peer a RPC query should be forwarded to</p>
<p><strong>transaction-only balancer</strong> : distributes the requests under the constraint of preserving consistency</p>
<h4 id="Performance-anomaly-detection-plus-security-deposit"><a href="#Performance-anomaly-detection-plus-security-deposit" class="headerlink" title="Performance anomaly detection plus security deposit"></a>Performance anomaly detection plus security deposit</h4><p>require security deposit from any potential clients</p>
<p><strong>Key condition:</strong> the performance monitor can distinguish malicious DoERS requests from benign RPCs</p>
<h4 id="Interruptible-EVM-instructions"><a href="#Interruptible-EVM-instructions" class="headerlink" title="Interruptible EVM instructions"></a>Interruptible EVM instructions</h4><p><strong>Problem</strong>: atomic EVM instructions: success of single- request DoERS</p>
<p><strong>Solution</strong>: execution of a single instruction (e.g., CODECOPY in exhaustMem) to be interrupted by timeout</p>
<p><strong>Specific way</strong>: change EVM’s instruction scheduling algorithm and to enforce the maximal memory size allocated by a single CODECOPY call.</p>
<h2 id="CONCLUSION"><a href="#CONCLUSION" class="headerlink" title="CONCLUSION"></a>CONCLUSION</h2><p>The <strong>first measurement study</strong> on the security of <strong>Ethereum’s RPC-enabled nodes under DoS</strong> attacks.</p>
<p><strong>No gas limits</strong>: can be crashed by the proposed DoERS attack</p>
<p><strong>Configured Gas limits</strong>: a properly configured DoERS attack can cause a latency increase by 2.1× ∼ 50×</p>
<p><strong>mitigation</strong>: beyond simply limits the Gas at zero Ether cost</p>
<p>unpredictable load balancing</p>
<p>performance anomaly detection</p>
<p>interruptible EVM instructions.</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="https://yezzi.tech/2021/07/02/DoERS_note/" data-id="ckqm8q8ro0000r8u73voj903l" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-2020.5.31记录" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/02/2020.5.31%E8%AE%B0%E5%BD%95/">(no title)</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2021/07/02/2020.5.31%E8%AE%B0%E5%BD%95/" class="article-date"><time datetime="2021-07-02T11:06:38.661Z" itemprop="datePublished">2021-07-02</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>以太坊所缺少的：联盟链-身份认证 sdk调用全节点也可以是http rpc通信restful接口 ：身份+证书 双向认证SSL-TLS认证 是怎么实现的呢？</p>
<p>go源码 context.Context 上下文处理 </p>
<p>go源码 reflect 反射机制</p>
<p>go语法 包装的问题：装箱/设计模式 的wrapper如何实现的</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="https://yezzi.tech/2021/07/02/2020.5.31%E8%AE%B0%E5%BD%95/" data-id="ckqm8q8s50002r8u7e57e8zdf" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-BlockChain-Papers-in-Top-Security-Conferences" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/02/BlockChain-Papers-in-Top-Security-Conferences/">BlockChain Papers in Top Security Conferences</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2021/07/02/BlockChain-Papers-in-Top-Security-Conferences/" class="article-date"><time datetime="2021-07-02T10:37:40.000Z" itemprop="datePublished">2021-07-02</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="https://yezzi.tech/2021/07/02/BlockChain-Papers-in-Top-Security-Conferences/" data-id="ckqm8q8s10001r8u71yx43juv" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/paper-notes/" rel="tag">paper notes</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-go-http源码解析" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/17/go-http%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">go http源码解析</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/07/17/go-http%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="article-date"><time datetime="2020-07-17T09:09:56.000Z" itemprop="datePublished">2020-07-17</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>由于以太坊RPC网络涉及到很多golang http源码层的操作，于是决定学习一下go http源码的架构和细节。</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="https://yezzi.tech/2020/07/17/go-http%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" data-id="ckqm8q8t2000kr8u7ec4m0azp" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/" rel="tag">golang</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-以太坊中的数据结构" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/25/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">以太坊中的数据结构</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/02/25/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" class="article-date"><time datetime="2020-02-25T15:54:34.000Z" itemprop="datePublished">2020-02-25</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <details>
<summary>详细信息</summary>


<h3 id="1-区块"><a href="#1-区块" class="headerlink" title="1.区块"></a>1.区块</h3><p>区块主要由三部分组成：区块头（Block Header），叔块（Uncle），区块体（body）</p>
<h4 id="区块头"><a href="#区块头" class="headerlink" title="区块头"></a>区块头</h4><p>区块头的结构体定义：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Header <span class="keyword">struct</span> &#123; </span><br><span class="line">    ParentHash  common.Hash    <span class="string">`json:&quot;parentHash&quot;       gencodec:&quot;required&quot;`</span>  </span><br><span class="line">    UncleHash   common.Hash    <span class="string">`json:&quot;sha3Uncles&quot;       gencodec:&quot;required&quot;`</span>  </span><br><span class="line">    Coinbase    common.Address <span class="string">`json:&quot;miner&quot;            gencodec:&quot;required&quot;`</span>  </span><br><span class="line">    Root        common.Hash    <span class="string">`json:&quot;stateRoot&quot;        gencodec:&quot;required&quot;`</span> </span><br><span class="line">    TxHash      common.Hash    <span class="string">`json:&quot;transactionsRoot&quot; gencodec:&quot;required&quot;`</span>              ReceiptHash common.Hash    <span class="string">`json:&quot;receiptsRoot&quot;     gencodec:&quot;required&quot;`</span></span><br><span class="line">    Bloom       Bloom          <span class="string">`json:&quot;logsBloom&quot;        gencodec:&quot;required&quot;`</span> </span><br><span class="line">    Difficulty  *big.Int       <span class="string">`json:&quot;difficulty&quot;       gencodec:&quot;required&quot;`</span></span><br><span class="line">    Number      *big.Int       <span class="string">`json:&quot;number&quot;           gencodec:&quot;required&quot;`</span> </span><br><span class="line">    GasLimit    <span class="keyword">uint64</span>         <span class="string">`json:&quot;gasLimit&quot;         gencodec:&quot;required&quot;`</span> </span><br><span class="line">    GasUsed     <span class="keyword">uint64</span>         <span class="string">`json:&quot;gasUsed&quot;          gencodec:&quot;required&quot;`</span></span><br><span class="line">    Time        <span class="keyword">uint64</span>         <span class="string">`json:&quot;timestamp&quot;        gencodec:&quot;required&quot;`</span> </span><br><span class="line">    Extra       []<span class="keyword">byte</span>         <span class="string">`json:&quot;extraData&quot;        gencodec:&quot;required&quot;`</span>  </span><br><span class="line">    MixDigest   common.Hash    <span class="string">`json:&quot;mixHash&quot;`</span> </span><br><span class="line">    Nonce       BlockNonce     <span class="string">`json:&quot;nonce&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>释义如下：</p>
<p>ParentHash  common.Hash   父区块的哈希值<br>UncleHash    common.Hash    叔父区块列表的哈希值<br>Coinbase    common.Address    打包该区块的矿工的地址，用于接收矿工费<br>Root    common.Hash    状态树的根哈希值<br>TxHash    common.Hash    交易树的根哈希值<br>ReceiptHash    common.Hash    收据树的根哈希值<br>Bloom    Bloom    交易收据日志组成的Bloom过滤器<br>Difficulty    *Big.Int    本区块的难度<br>Number    *Big.Int    本区块块号，区块号从0号开始算起<br>GasLimit    uint64    本区块中所有交易消耗的Gas上限，这个数值不等于所有交易的中Gas limit字段的和<br>GasUsed    uint64    本区块中所有交易使用的Gas之和<br>Time    *big.Int    区块产生的unix时间戳，一般是打包区块的时间，这个字段不是出块的时间戳<br>Extra    []byte    区块的附加数据<br>MixDigest    common.Hash    哈希值，与Nonce的组合用于工作量计算<br>Nonce    BlockNonce    区块产生时的随机值</p>
<p>与比特币一样，以太坊中区块和区块之间用哈希指针向连，通过哈希可以追溯到最初的区块。</p>
<p>轻节点只保存区块头。</p>
<h4 id="叔块"><a href="#叔块" class="headerlink" title="叔块"></a>叔块</h4><h5 id="孤块-orphan-block"><a href="#孤块-orphan-block" class="headerlink" title="孤块(orphan block)"></a>孤块(orphan block)</h5><p>在比特币协议中，最长的链被认为是绝对的正确。如果一个块不是最长链的一部分，那么它被称为是“孤块”。一个孤立的块是一个块，它也是合法的，但是发现的稍晚，或者是网络传输稍慢，而没有能成为最长的链的一部分。在比特币中，孤块没有意义，随后将被抛弃，发现这个孤块的矿工也拿不到采矿相关的奖励。</p>
<h5 id="最重的链-heaviest"><a href="#最重的链-heaviest" class="headerlink" title="最重的链(heaviest)"></a>最重的链(heaviest)</h5><p>Ethereum的GHOST协议，不认为孤块没有价值，而是会给与发现孤块的矿工以回报。在以太坊中，孤块被称为“叔块”(uncle block)，它们可以为主链的安全作出贡献。</p>
<p>相对来说，比特币有很长的块间隔时间。在比特币区块中，平均约10分钟可以得到一个确认(也就是发现一个新的后续区块)。但是自从比特币成立以来，大量关于块链技术的研究已经发展起来。这些研究表明，更短的块间隔确实是可能的，而且在很多应用场景下是需要的。然而，随着拥有更快的出块速度，孤块的增加而带来的昂贵的成本和浪费也随之增加。</p>
<p>GHOST协议支付报酬给叔块，这激励了矿工在新发现的块中去引用叔块。引用叔块使主链更重。在比特币，最长的链是主链。在以太坊中，主链是指最重的链。</p>
<h5 id="叔块的好处"><a href="#叔块的好处" class="headerlink" title="叔块的好处"></a>叔块的好处</h5><p>解决了两个问题：</p>
<ol>
<li>以太坊十几秒的出块间隔，大大增加了孤块的产生，并且降低了安全性。通过鼓励引用叔块，使引用主链获得更多的安全保证(因为孤块本身也是合法的)</li>
<li>比特币中，采矿中心化(大量的集中矿池)成为一个问题。给与叔块报酬，可以一定程度上缓解这个问题。</li>
</ol>
<h5 id="叔块的引用"><a href="#叔块的引用" class="headerlink" title="叔块的引用"></a>叔块的引用</h5><p>区块可以不引用，或者最多引用两个叔块<br>叔块必须是区块的前2层~前7层的祖先的直接的子块<br>被引用过的叔块不能重复引用<br>引用叔块的区块，可以获得挖矿报酬的1/32，也就是5<em>1/32=0.15625 Ether。最多获得2</em>0.15625=0.3125 Ether<br>被引用的叔块，其矿工的报酬和叔块与区块之间的间隔层数有关系。</p>
<table>
<thead>
<tr>
<th>间隔层数</th>
<th>报酬比例</th>
<th>报酬</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>7/8</td>
<td>4.375</td>
</tr>
<tr>
<td>2</td>
<td>6/8</td>
<td>3.75</td>
</tr>
<tr>
<td>3</td>
<td>5/8</td>
<td>3.125</td>
</tr>
<tr>
<td>4</td>
<td>4/8</td>
<td>2.5</td>
</tr>
<tr>
<td>5</td>
<td>3/8</td>
<td>1.875</td>
</tr>
<tr>
<td>6</td>
<td>2/8</td>
<td>1.25</td>
</tr>
</tbody></table>
<h4 id="区块体"><a href="#区块体" class="headerlink" title="区块体"></a>区块体</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Body <span class="keyword">struct</span> &#123;</span><br><span class="line">    Transactions []*Transaction  </span><br><span class="line">    Uncles       []*Header</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Body是一个简单的（可变的、非安全的）数据容器，用于存储和移动块的数据内容（事务和uncles）。</p>
<h4 id="完整的区块定义"><a href="#完整的区块定义" class="headerlink" title="完整的区块定义"></a>完整的区块定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Block <span class="keyword">struct</span> &#123;   </span><br><span class="line">    header       *Header  </span><br><span class="line">    uncles       []*Header </span><br><span class="line">    transactions Transactions </span><br><span class="line">    <span class="comment">// caches   hash atomic.Value   size atomic.Value  </span></span><br><span class="line">    <span class="comment">// Td is used by package core to store the total difficulty   </span></span><br><span class="line">    <span class="comment">// of the chain up to and including the block.   td *big.Int  </span></span><br><span class="line">    <span class="comment">// These fields are used by package eth to track  </span></span><br><span class="line">    <span class="comment">// inter-peer block relay.   ReceivedAt   time.</span></span><br><span class="line">    Time   ReceivedFrom <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-MPT树"><a href="#2-MPT树" class="headerlink" title="2.MPT树"></a>2.MPT树</h3><h4 id="trie"><a href="#trie" class="headerlink" title="trie"></a>trie</h4><p>trie也叫字典树，前缀树，因为它的搜索快捷的特性被单词搜索系统使用，故又称单词查找树。它是一种树形结构的数据结构。之所以快速，是因为它用空间代替了速度。</p>
<p>如给出字符串”abc”,”ab”,”bd”,”dda”，根据该字符串序列构建一棵Trie树。则构建的树如下: </p>
<p><img src="./1.jpg"></p>
<h4 id="Patricia-Trie"><a href="#Patricia-Trie" class="headerlink" title="Patricia Trie"></a>Patricia Trie</h4><p>又叫做基数树，压缩前缀树或紧凑前缀树（compact prefix tree)，是一种更节省空间的前缀树。它与 Trie 的区别是，如果某个节点只有一个子树，那么这个子树跟父节点合并，这样可以缩短 Trie 里不必要的深度，节约存储空间，加快搜索节点的速度。 </p>
<p><img src="./2.png"></p>
<p> 以太坊中每个用户地址是160位存储，如果使用不压缩的trie会造成非常大的存储浪费，维护状态树会变得异常困难。所以使用压缩前缀树。 </p>
<h4 id="Merkle-Tree"><a href="#Merkle-Tree" class="headerlink" title="Merkle Tree"></a>Merkle Tree</h4><p>比特币中，交易列表使用非排序的默克尔树存储，其和二叉树的区别主要是使用哈希指针代替了二叉树中的指针。</p>
<p><img src="./3.png"></p>
<h4 id="Merkle-Patricia-Tree-Trie"><a href="#Merkle-Patricia-Tree-Trie" class="headerlink" title="Merkle Patricia Tree (Trie)"></a>Merkle Patricia Tree (Trie)</h4><p>Merkle Patricia Tree 默克尔-帕特里夏树是一种融合了默克尔树和前缀树两种结构优点的，经过改良的数据结构，在以太坊中用来组织交易信息、账户状态及其变更、收据相关的数据。</p>
<p>以太坊中的MPT树是经过改良的，模范化的MPT树。</p>
<p><img src="./4.png"></p>
<p>树中的节点分类：</p>
<p>空节点 </p>
<p>分支节点 </p>
<p>叶子节点 </p>
<p>扩展节点 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> node <span class="keyword">interface</span> &#123;	</span><br><span class="line">    fstring(<span class="keyword">string</span>) <span class="keyword">string</span>	</span><br><span class="line">    cache() (hashNode, <span class="keyword">bool</span>)	</span><br><span class="line">    canUnload(cachegen, cachelimit <span class="keyword">uint16</span>) <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> (	</span><br><span class="line">    </span><br><span class="line">    fullNode <span class="keyword">struct</span> &#123;	</span><br><span class="line">        Children [<span class="number">17</span>]node		</span><br><span class="line">        flags    nodeFlag	</span><br><span class="line">    &#125;	</span><br><span class="line">    shortNode <span class="keyword">struct</span> &#123;	</span><br><span class="line">        Key   []<span class="keyword">byte</span>		Val   node		flags nodeFlag	</span><br><span class="line">    &#125;	</span><br><span class="line">    hashNode  []<span class="keyword">byte</span></span><br><span class="line">    valueNode []<span class="keyword">byte</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> nodeFlag <span class="keyword">struct</span></span><br><span class="line">&#123;	</span><br><span class="line">    hash  hashNode	</span><br><span class="line">    gen   <span class="keyword">uint16</span>	</span><br><span class="line">    dirty <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="fullNode"><a href="#fullNode" class="headerlink" title="fullNode"></a>fullNode</h6><p>fullNode 是一个可以携带多个子节点的节点。它有一个 node 数组类型的成员变量 Children，数组的前16个空位分别对应十六进制的0-9a-f，对于每个子节点，根据其 key 值的十六进制表示一一对应，Children 数组的第17位，fullNode 用来存储数据。</p>
<p>对应黄皮书中的分支节点。</p>
<h6 id="shortNode"><a href="#shortNode" class="headerlink" title="shortNode"></a>shortNode</h6><p>shortNode 是一个仅有一个子节点的节点。成员变量 Val 指向一个子节点，成员变量 Key 是一个由任意长度的字符串，这体现了压缩前缀树的特点，通过合并只有一个子节点的父节点和其子节点来缩短 Trie 的深度。</p>
<p>对应黄皮书里的扩展节点和叶子节点，通过 <code>shortNode.Val</code> 的类型来对应。</p>
<h6 id="valueNode"><a href="#valueNode" class="headerlink" title="valueNode"></a>valueNode</h6><p>valueNode 在 MPT 结构中存储真正的数据。充当 MPT 的叶子节点，不带子节点。</p>
<p>valueNode 是一个字节数组，但是它实现了 <code>fstring(string) string</code>, <code>cache() (hashNode, bool)</code>, <code>canUnload(cachegen, cachelimit uint16) bool</code> 这三个接口（实际上 fullNode，shortNode，hashNode 也实现了这三个接口），因此可以作为 fullNode，shortNode 中的 <code>node</code> 使用。valueNode 可以承接数据，携带的的是数据的 RLP 哈希值，长度为 32 byte，RLP 编码的值存在 LevelDB 里。</p>
<h6 id="hashNode"><a href="#hashNode" class="headerlink" title="hashNode"></a>hashNode</h6><p>hashNode 是 fullNode 或 shortNode 对象的 RLP 编码的32 byte 的哈希值，表明该节点还没有载入内存。遍历 MPT 时有时会遇到一个 hashNode，表明原来的 node 需要动态加载，hashNode 以 nodeFlag 结构体的成员 hash 的形式存在，如果 fullNode 或 shortNode 的成员变量发生变化，那么就需要更新它的 hashNode，在增删改的过程结束了都会调用 <code>trie.Hash()</code>，整个 MPT 自底向上变量，对所有清空的 hashNode 重新赋值，最终得到根节点的 hashNode，也就是整个 MPT 结构的哈希值。</p>
<p>fullNode 体现了 Trie 的特点，shortNode 实现了 PatriciaTrie 的特性（当然也实现了 Trie 的特性），hashNode 既实现了 MPT 节点的动态加载，也实现了默克尔树的功能。</p>
</details>
      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="https://yezzi.tech/2020/02/25/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" data-id="ckqm8q8tp0012r8u74ofm46ov" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag">区块链</a></li></ul>


    </footer>
  </div>
  
</article>



  


  <div id="page-nav">
    <nav><ul class="pagination"><li><a class="page-prev" rel="prev" href="/page/2/"><i class="fa fa-chevron-left"></i> Prev</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li class="active"><span class="page-number">3</span></li><li><a class="page-number" href="/page/4/">4</a></li><li><a class="page-next" rel="next" href="/page/4/">Next <i class="fa fa-chevron-right"></i></a></li></ul></nav>
  </div>



        </div>
        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
          
  <div class="sidebar-module sidebar-module-inset">
  <h4>About</h4>
  <p> Nice papers collected in the field of <em>AI</em>, <em>Apllied Cryptography</em> and <em>Blockchain</em>, records of some computer technologies, and personal thoughts.  If you are inteseted in my field, feel free to contact me. (Wechat: mzliu_xdu) </p>

</div>


  


  
  <div class="sidebar-module">
    <h4>Tags</h4>
    <ul class="sidebar-module-list" itemprop="keywords"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/go/" rel="tag">go</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/golang/" rel="tag">golang</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/hyperledger-fabric/" rel="tag">hyperledger fabric</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/java/" rel="tag">java</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/paper-notes/" rel="tag">paper notes</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" rel="tag">以太坊</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag">区块链</a><span class="sidebar-module-list-count">1</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tag Cloud</h4>
    <p class="tagcloud">
      <a href="/tags/go/" style="font-size: 20px;">go</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/hyperledger-fabric/" style="font-size: 20px;">hyperledger fabric</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/paper-notes/" style="font-size: 10px;">paper notes</a> <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" style="font-size: 10px;">以太坊</a> <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" style="font-size: 10px;">区块链</a>
    </p>
  </div>


  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2021/07/">July 2021</a><span class="sidebar-module-list-count">28</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/07/">July 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/02/">February 2020</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/10/">October 2019</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/08/">August 2019</a><span class="sidebar-module-list-count">2</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2021/07/02/%E9%97%AE%E9%A2%98/">(no title)</a>
        </li>
      
        <li>
          <a href="/2021/07/02/%E7%8A%B6%E6%80%81%EF%BC%9B%E7%8A%B6%E6%80%81%E6%A0%91%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">(no title)</a>
        </li>
      
        <li>
          <a href="/2021/07/02/%E5%90%8E%E7%AB%AF%E6%96%87%E6%A1%A3/">(no title)</a>
        </li>
      
        <li>
          <a href="/2021/07/02/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%B5%8F%E8%A7%88%E5%99%A8%E5%90%8E%E7%AB%AF%E8%AF%B4%E6%98%8E/">(no title)</a>
        </li>
      
        <li>
          <a href="/2021/07/02/%E5%8C%BA%E5%9D%97%E4%B8%AD%E7%9A%84%E4%BA%A4%E6%98%93%E5%92%8C%E5%9B%9E%E6%89%A7%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">(no title)</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2021 Mingzhe Liu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

  

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>




<script src="/js/script.js"></script>


</body>
</html>
