<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>以太坊控制台代码分析 | Yezzi Tech</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="goja实现的以太坊控制台，创建javascript交互式环境">
<meta property="og:type" content="article">
<meta property="og:title" content="以太坊控制台代码分析">
<meta property="og:url" content="https://yezzi.tech/2019/10/22/geth%E6%8E%A7%E5%88%B6%E5%8F%B0%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Yezzi Tech">
<meta property="og:description" content="goja实现的以太坊控制台，创建javascript交互式环境">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/729358-839e7a32b598953e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/500/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/729358-de38e5423ffbc3e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/589/format/webp">
<meta property="article:published_time" content="2019-10-22T02:08:41.000Z">
<meta property="article:modified_time" content="2021-07-04T02:48:09.447Z">
<meta property="article:author" content="Mingzhe Liu">
<meta property="article:tag" content="以太坊">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/729358-839e7a32b598953e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/500/format/webp">
  
    <link rel="alternate" href="/atom.xml" title="Yezzi Tech" type="application/atom+xml">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  
<link rel="stylesheet" href="/css/styles.css">

  

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class=""
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
          <li><a href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a></li>
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">Yezzi Tech</h1>
  
</div>

    <div class="row">
        <div class="col-sm-8 blog-main">
          <article id="post-geth控制台代码分析" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 class="article-title" itemprop="name">
      以太坊控制台代码分析
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2019/10/22/geth%E6%8E%A7%E5%88%B6%E5%8F%B0%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" class="article-date"><time datetime="2019-10-22T02:08:41.000Z" itemprop="datePublished">2019-10-22</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>goja实现的以太坊控制台，创建javascript交互式环境</p>
<span id="more"></span>

<h4 id="1-goja"><a href="#1-goja" class="headerlink" title="1.goja"></a>1.goja</h4><p>goja 是一个 Go 实现的 ECMAScript 5.1(+)。</p>
<p>它不是 V8 或 SpiderMonkey 或任何其他通用 JavaScript 引擎的替代品，因为它更慢。它可以作为一种嵌入式脚本语言使用，或者可以作为避免非 Go 相关性的一种方式。</p>
<p>灵感来源于 <a target="_blank" rel="noopener" href="https://github.com/robertkrimen/otto">otto</a> 。完全支持 ECMAScript 5.1，通过几乎所有用 es5id 标记的 tc39 测试，平均比 otto 快6-7倍，同时使用相当少的内存。</p>
<p>简单的理解是，在go里面写javascript，这样就可以以脚本的方式实现控制台，并和geth实时交互。</p>
<h4 id="2-RPC"><a href="#2-RPC" class="headerlink" title="2.RPC"></a>2.RPC</h4><p>默认socket通信。本地机器的RPC框架反序列化出执行结果，函数return这个结果。</p>
<p> <img src="https://upload-images.jianshu.io/upload_images/729358-839e7a32b598953e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/500/format/webp" alt="img"> </p>
<p><strong>Call ID映射。</strong>我们怎么告诉远程机器我们要调用Multiply，而不是Add或者FooBar呢？在本地调用中，函数体是直接通过函数指针来指定的，我们调用Multiply，编译器就自动帮我们调用它相应的函数指针。但是在远程调用中，函数指针是不行的，因为两个进程的地址空间是完全不一样的。所以，在RPC中，所有的函数都必须有自己的一个ID。这个ID在所有进程中都是唯一确定的。客户端在做远程过程调用时，必须附上这个ID。然后我们还需要在客户端和服务端分别维护一个 {函数 &lt;–&gt; Call ID} 的对应表。两者的表不一定需要完全相同，但相同的函数对应的Call ID必须相同。当客户端需要进行远程调用时，它就查一下这个表，找出相应的Call ID，然后把它传给服务端，服务端也通过查表，来确定客户端需要调用的函数，然后执行相应函数的代码。</p>
<p><strong>序列化和反序列化。</strong>客户端怎么把参数值传给远程的函数呢？在本地调用中，我们只需要把参数压到栈里，然后让函数自己去栈里读就行。但是在远程过程调用时，客户端跟服务端是不同的进程，不能通过内存来传递参数。甚至有时候客户端和服务端使用的都不是同一种语言（比如服务端用C++，客户端用Java或者Python）。这时候就需要客户端把参数先转成一个字节流，传给服务端后，再把字节流转成自己能读取的格式。这个过程叫序列化和反序列化。同理，从服务端返回的值也需要序列化反序列化的过程。</p>
<p><strong>网络传输。</strong>远程调用往往用在网络上，客户端和服务端是通过网络连接的。所有的数据都需要通过网络传输，因此就需要有一个网络传输层。网络传输层需要把Call ID和序列化后的参数字节流传给服务端，然后再把序列化后的调用结果传回客户端。只要能完成这两者的，都可以作为传输层使用。因此，它所使用的协议其实是不限的，能完成传输就行。尽管大部分RPC框架都使用TCP协议，但其实UDP也可以，而gRPC干脆就用了HTTP2。Java的Netty也属于这层的东西。</p>
<p> <img src="https://upload-images.jianshu.io/upload_images/729358-de38e5423ffbc3e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/589/format/webp" alt="img"> </p>
<p><strong>3.控制台原理</strong></p>
<p>geth/main.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Initialize the CLI app and start Geth</span></span><br><span class="line">	app.Action = geth</span><br><span class="line">	app.HideVersion = <span class="literal">true</span> <span class="comment">// we have a command to print the version</span></span><br><span class="line">	app.Copyright = <span class="string">&quot;Copyright 2013-2020 The go-ethereum Authors&quot;</span></span><br><span class="line">	app.Commands = []cli.Command&#123;</span><br><span class="line">		<span class="comment">// See chaincmd.go:</span></span><br><span class="line">		...</span><br><span class="line">		consoleCommand,</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>geth/consolecmd.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">consoleCommand = cli.Command&#123;</span><br><span class="line">		Action:   utils.MigrateFlags(localConsole),</span><br><span class="line">		Name:     <span class="string">&quot;console&quot;</span>,</span><br><span class="line">		Usage:    <span class="string">&quot;Start an interactive JavaScript environment&quot;</span>,</span><br><span class="line">		Flags:    <span class="built_in">append</span>(<span class="built_in">append</span>(<span class="built_in">append</span>(nodeFlags, rpcFlags...), consoleFlags...), whisperFlags...),</span><br><span class="line">		Category: <span class="string">&quot;CONSOLE COMMANDS&quot;</span>,</span><br><span class="line">		Description: <span class="string">`</span></span><br><span class="line"><span class="string">The Geth console is an interactive shell for the JavaScript runtime environment</span></span><br><span class="line"><span class="string">which exposes a node admin interface as well as the Ðapp JavaScript API.</span></span><br><span class="line"><span class="string">See https://github.com/ethereum/go-ethereum/wiki/JavaScript-Console.`</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// localConsole starts a new geth node, attaching a JavaScript console to it at the</span></span><br><span class="line"><span class="comment">// same time.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">localConsole</span><span class="params">(ctx *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// Create and start the node based on the CLI flags</span></span><br><span class="line">    <span class="comment">// 和geth命令有些相似，只不过没有node.wait（），就是启动一个节点</span></span><br><span class="line">	prepare(ctx)</span><br><span class="line">	node := makeFullNode(ctx)</span><br><span class="line">	startNode(ctx, node)</span><br><span class="line">	<span class="keyword">defer</span> node.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Attach to the newly started node and start the JavaScript console</span></span><br><span class="line">	client, err := node.Attach()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;Failed to attach to the inproc geth: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	config := console.Config&#123;</span><br><span class="line">		DataDir: utils.MakeDataDir(ctx),</span><br><span class="line">		DocRoot: ctx.GlobalString(utils.JSpathFlag.Name),</span><br><span class="line">		Client:  client,</span><br><span class="line">		Preload: utils.MakeConsolePreloads(ctx),</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//新建控制台</span></span><br><span class="line">	console, err := console.New(config)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utils.Fatalf(<span class="string">&quot;Failed to start the JavaScript console: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> console.Stop(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If only a short execution was requested, evaluate and return</span></span><br><span class="line">	<span class="keyword">if</span> script := ctx.GlobalString(utils.ExecFlag.Name); script != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		console.Evaluate(script)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Otherwise print the welcome screen and enter interactive mode</span></span><br><span class="line">    <span class="comment">// 说欢迎，开启交互模式</span></span><br><span class="line">	console.Welcome()</span><br><span class="line">	console.Interactive()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>console/bridge.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bridge is a collection of JavaScript utility methods to bride the .js runtime</span></span><br><span class="line"><span class="comment">// environment and the Go RPC connection backing the remote method calls.</span></span><br><span class="line"><span class="keyword">type</span> bridge <span class="keyword">struct</span> &#123;</span><br><span class="line">	client   *rpc.Client  <span class="comment">// RPC client to execute Ethereum requests through</span></span><br><span class="line">	prompter UserPrompter <span class="comment">// Input prompter to allow interactive user feedback输入提示，允许交互式用户反馈</span></span><br><span class="line">	printer  io.Writer    <span class="comment">// Output writer to serialize any display strings序列化 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// newBridge creates a new JavaScript wrapper around an RPC client.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newBridge</span><span class="params">(client *rpc.Client, prompter UserPrompter, printer io.Writer)</span> *<span class="title">bridge</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;bridge&#123;</span><br><span class="line">		client:   client,</span><br><span class="line">		prompter: prompter,</span><br><span class="line">		printer:  printer,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>console/console.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init retrieves the available APIs from the remote RPC provider and initializes</span></span><br><span class="line"><span class="comment">// the console&#x27;s JavaScript namespaces based on the exposed modules.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Console)</span> <span class="title">init</span><span class="params">(preload []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	c.initConsoleObject()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize the JavaScript &lt;-&gt; Go RPC bridge.</span></span><br><span class="line">	bridge := newBridge(c.client, c.prompter, c.printer)</span><br><span class="line">	<span class="keyword">if</span> err := c.initWeb3(bridge); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := c.initExtensions(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add bridge overrides for web3.js functionality.</span></span><br><span class="line">	c.jsre.Do(<span class="function"><span class="keyword">func</span><span class="params">(vm *goja.Runtime)</span></span> &#123;</span><br><span class="line">		c.initAdmin(vm, bridge)</span><br><span class="line">		c.initPersonal(vm, bridge)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Preload JavaScript files.</span></span><br><span class="line">	<span class="keyword">for</span> _, path := <span class="keyword">range</span> preload &#123;</span><br><span class="line">		<span class="keyword">if</span> err := c.jsre.Exec(path); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			failure := err.Error()</span><br><span class="line">			<span class="keyword">if</span> gojaErr, ok := err.(*goja.Exception); ok &#123;</span><br><span class="line">				failure = gojaErr.String()</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s: %v&quot;</span>, path, failure)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Configure the input prompter for history and tab completion.</span></span><br><span class="line">    <span class="comment">// 为历史记录和制表符完成配置输入提示。</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> c.prompter != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> content, err := ioutil.ReadFile(c.histPath); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.prompter.SetHistory(<span class="literal">nil</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			c.history = strings.Split(<span class="keyword">string</span>(content), <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">			c.prompter.SetHistory(c.history)</span><br><span class="line">		&#125;</span><br><span class="line">		c.prompter.SetWordCompleter(c.AutoCompleteInput)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(config Config)</span> <span class="params">(*Console, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Handle unset config values gracefully</span></span><br><span class="line">	<span class="keyword">if</span> config.Prompter == <span class="literal">nil</span> &#123;</span><br><span class="line">		config.Prompter = Stdin</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> config.Prompt == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		config.Prompt = DefaultPrompt</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> config.Printer == <span class="literal">nil</span> &#123;</span><br><span class="line">		config.Printer = colorable.NewColorableStdout()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize the console and return</span></span><br><span class="line">	console := &amp;Console&#123;</span><br><span class="line">		client:   config.Client,</span><br><span class="line">		jsre:     jsre.New(config.DocRoot, config.Printer),</span><br><span class="line">		prompt:   config.Prompt,</span><br><span class="line">		prompter: config.Prompter,</span><br><span class="line">		printer:  config.Printer,</span><br><span class="line">		histPath: filepath.Join(config.DataDir, HistoryFile),</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := os.MkdirAll(config.DataDir, <span class="number">0700</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := console.init(config.Preload); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> console, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Welcome show summary of current Geth instance and some metadata about the</span></span><br><span class="line"><span class="comment">// console&#x27;s available modules.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Console)</span> <span class="title">Welcome</span><span class="params">()</span></span> &#123;</span><br><span class="line">	message := <span class="string">&quot;Welcome to the Geth JavaScript console!\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Print some generic Geth metadata</span></span><br><span class="line">	<span class="keyword">if</span> res, err := c.jsre.Run(<span class="string">`</span></span><br><span class="line"><span class="string">		var message = &quot;instance: &quot; + web3.version.node + &quot;\n&quot;;</span></span><br><span class="line"><span class="string">		try &#123;</span></span><br><span class="line"><span class="string">			message += &quot;coinbase: &quot; + eth.coinbase + &quot;\n&quot;;</span></span><br><span class="line"><span class="string">		&#125; catch (err) &#123;&#125;</span></span><br><span class="line"><span class="string">		message += &quot;at block: &quot; + eth.blockNumber + &quot; (&quot; + new Date(1000 * eth.getBlock(eth.blockNumber).timestamp) + &quot;)\n&quot;;</span></span><br><span class="line"><span class="string">		try &#123;</span></span><br><span class="line"><span class="string">			message += &quot; datadir: &quot; + admin.datadir + &quot;\n&quot;;</span></span><br><span class="line"><span class="string">		&#125; catch (err) &#123;&#125;</span></span><br><span class="line"><span class="string">		message</span></span><br><span class="line"><span class="string">	`</span>); </span><br><span class="line">    ...</span><br><span class="line">	fmt.Fprintln(c.printer, message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Interactive starts an interactive user session, where input is propted from</span></span><br><span class="line"><span class="comment">// the configured user prompter.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Console)</span> <span class="title">Interactive</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-一个交互举例子"><a href="#4-一个交互举例子" class="headerlink" title="4.一个交互举例子"></a>4.一个交互举例子</h4><p>console/console.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Console)</span> <span class="title">initWeb3</span><span class="params">(bridge *bridge)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	bnJS := <span class="keyword">string</span>(deps.MustAsset(<span class="string">&quot;bignumber.js&quot;</span>))</span><br><span class="line">	web3JS := <span class="keyword">string</span>(deps.MustAsset(<span class="string">&quot;web3.js&quot;</span>))</span><br><span class="line">	<span class="keyword">if</span> err := c.jsre.Compile(<span class="string">&quot;bignumber.js&quot;</span>, bnJS); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;bignumber.js: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := c.jsre.Compile(<span class="string">&quot;web3.js&quot;</span>, web3JS); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;web3.js: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> _, err := c.jsre.Run(<span class="string">&quot;var Web3 = require(&#x27;web3&#x27;);&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;web3 require: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	c.jsre.Do(<span class="function"><span class="keyword">func</span><span class="params">(vm *goja.Runtime)</span></span> &#123;</span><br><span class="line">		transport := vm.NewObject()</span><br><span class="line">		transport.Set(<span class="string">&quot;send&quot;</span>, jsre.MakeCallback(vm, bridge.Send))</span><br><span class="line">		transport.Set(<span class="string">&quot;sendAsync&quot;</span>, jsre.MakeCallback(vm, bridge.Send))</span><br><span class="line">		vm.Set(<span class="string">&quot;_consoleWeb3Transport&quot;</span>, transport)</span><br><span class="line">		_, err = vm.RunString(<span class="string">&quot;var web3 = new Web3(_consoleWeb3Transport)&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拿其中的send方法举例</p>
<p>console/bridge.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Send implements the web3 provider &quot;send&quot; method.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *bridge)</span> <span class="title">Send</span><span class="params">(call jsre.Call)</span> <span class="params">(goja.Value, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Remarshal the request into a Go value.</span></span><br><span class="line">	reqVal, err := call.Argument(<span class="number">0</span>).ToObject(call.VM).MarshalJSON()</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		rawReq = <span class="keyword">string</span>(reqVal)</span><br><span class="line">		dec    = json.NewDecoder(strings.NewReader(rawReq))</span><br><span class="line">		reqs   []jsonrpcCall</span><br><span class="line">		batch  <span class="keyword">bool</span></span><br><span class="line">	)</span><br><span class="line">	dec.UseNumber() <span class="comment">// avoid float64s</span></span><br><span class="line">	<span class="keyword">if</span> rawReq[<span class="number">0</span>] == <span class="string">&#x27;[&#x27;</span> &#123;</span><br><span class="line">		batch = <span class="literal">true</span></span><br><span class="line">		dec.Decode(&amp;reqs)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		batch = <span class="literal">false</span></span><br><span class="line">		reqs = <span class="built_in">make</span>([]jsonrpcCall, <span class="number">1</span>)</span><br><span class="line">		dec.Decode(&amp;reqs[<span class="number">0</span>])</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Execute the requests.</span></span><br><span class="line">	<span class="keyword">var</span> resps []*goja.Object</span><br><span class="line">	<span class="keyword">for</span> _, req := <span class="keyword">range</span> reqs &#123;</span><br><span class="line">		resp := call.VM.NewObject()</span><br><span class="line">		resp.Set(<span class="string">&quot;jsonrpc&quot;</span>, <span class="string">&quot;2.0&quot;</span>)</span><br><span class="line">		resp.Set(<span class="string">&quot;id&quot;</span>, req.ID)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> result json.RawMessage</span><br><span class="line">        <span class="comment">//比较重要的一步，rpc调用</span></span><br><span class="line">		err = b.client.Call(&amp;result, req.Method, req.Params...)</span><br><span class="line">		<span class="keyword">switch</span> err := err.(<span class="keyword">type</span>) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="literal">nil</span>:</span><br><span class="line">			<span class="keyword">if</span> result == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="comment">// Special case null because it is decoded as an empty</span></span><br><span class="line">				<span class="comment">// raw message for some reason.</span></span><br><span class="line">				resp.Set(<span class="string">&quot;result&quot;</span>, goja.Null())</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				JSON := call.VM.Get(<span class="string">&quot;JSON&quot;</span>).ToObject(call.VM)</span><br><span class="line">				parse, callable := goja.AssertFunction(JSON.Get(<span class="string">&quot;parse&quot;</span>))</span><br><span class="line">				<span class="keyword">if</span> !callable &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;JSON.parse is not a function&quot;</span>)</span><br><span class="line">				&#125;</span><br><span class="line">				resultVal, err := parse(goja.Null(), call.VM.ToValue(<span class="keyword">string</span>(result)))</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					setError(resp, <span class="number">-32603</span>, err.Error())</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					resp.Set(<span class="string">&quot;result&quot;</span>, resultVal)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> rpc.Error:</span><br><span class="line">			setError(resp, err.ErrorCode(), err.Error())</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			setError(resp, <span class="number">-32603</span>, err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">		resps = <span class="built_in">append</span>(resps, resp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Return the responses either to the callback (if supplied)</span></span><br><span class="line">	<span class="comment">// or directly as the return value.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将响应返回给回调（如果提供）</span></span><br><span class="line">    <span class="comment">//或直接作为返回值。</span></span><br><span class="line">	<span class="keyword">var</span> result goja.Value</span><br><span class="line">	<span class="keyword">if</span> batch &#123;</span><br><span class="line">		result = call.VM.ToValue(resps)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		result = resps[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> fn, isFunc := goja.AssertFunction(call.Argument(<span class="number">1</span>)); isFunc &#123;</span><br><span class="line">		fn(goja.Null(), goja.Null(), result)</span><br><span class="line">		<span class="keyword">return</span> goja.Undefined(), <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="https://yezzi.tech/2019/10/22/geth%E6%8E%A7%E5%88%B6%E5%8F%B0%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" data-id="ckqoyya3i000ixcu70rdrc16m" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" rel="tag">以太坊</a></li></ul>


    </footer>
  </div>
  
    
<ul id="article-nav" class="nav nav-pills nav-justified">
  
  <li role="presentation">
    <a href="/2019/10/09/json%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95/" id="article-nav-older" class="article-nav-link-wrap">
      <i class="fa fa-chevron-left pull-left"></i>
      <span class="article-nav-link-title">go中的struct和json</span>
    </a>
  </li>
  
  
  <li role="presentation">
    <a href="/2019/10/22/geth%E5%90%AF%E5%8A%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%883%EF%BC%89/" id="article-nav-newer" class="article-nav-link-wrap">
      <span class="article-nav-link-title">以太坊主进程启动代码分析 part2(共2部分)</span>
      <i class="fa fa-chevron-right pull-right"></i>
    </a>
  </li>
  
</ul>


  
</article>




        </div>
        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
          
  <div class="sidebar-module sidebar-module-inset">
  <h4>About</h4>
  <p> Nice papers collected in the field of <em>AI</em>, <em>Apllied Cryptography</em> and <em>Blockchain</em>, records of some computer technologies, and personal thoughts.  If you are inteseted in my field, feel free to contact me. (Wechat: mzliu_xdu) </p>

</div>


  


  
  <div class="sidebar-module">
    <h4>Tags</h4>
    <ul class="sidebar-module-list" itemprop="keywords"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Bitcoin/" rel="tag">Bitcoin</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Projects/" rel="tag">Projects</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/golang/" rel="tag">golang</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/hyperledger-fabric/" rel="tag">hyperledger fabric</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/java/" rel="tag">java</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/paper-notes/" rel="tag">paper notes</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" rel="tag">以太坊</a><span class="sidebar-module-list-count">18</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a><span class="sidebar-module-list-count">1</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tag Cloud</h4>
    <p class="tagcloud">
      <a href="/tags/Bitcoin/" style="font-size: 10px;">Bitcoin</a> <a href="/tags/Projects/" style="font-size: 16px;">Projects</a> <a href="/tags/golang/" style="font-size: 18px;">golang</a> <a href="/tags/hyperledger-fabric/" style="font-size: 12px;">hyperledger fabric</a> <a href="/tags/java/" style="font-size: 12px;">java</a> <a href="/tags/paper-notes/" style="font-size: 14px;">paper notes</a> <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" style="font-size: 20px;">以太坊</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">前端</a>
    </p>
  </div>


  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2021/07/">July 2021</a><span class="sidebar-module-list-count">16</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/02/">February 2020</a><span class="sidebar-module-list-count">9</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/10/">October 2019</a><span class="sidebar-module-list-count">9</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/08/">August 2019</a><span class="sidebar-module-list-count">2</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2021/07/04/shuffle/">shuffle</a>
        </li>
      
        <li>
          <a href="/2021/07/04/%E8%9E%8D%E4%BF%A1%E9%93%BE/">融信链</a>
        </li>
      
        <li>
          <a href="/2021/07/04/MaskChain/">MaskChain隐私计算链</a>
        </li>
      
        <li>
          <a href="/2021/07/02/DoERS_note/">DoERS notes</a>
        </li>
      
        <li>
          <a href="/2021/07/02/ML-Papers-in-Top-Security-Conferences/">ML Papers in Top Security Conferences</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2021 Mingzhe Liu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

  

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>




<script src="/js/script.js"></script>


</body>
</html>
